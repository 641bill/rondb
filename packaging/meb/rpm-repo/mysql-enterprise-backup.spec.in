# -*- rpm-spec -*-

# Copyright (c) 2016, 2017, Oracle and/or its affiliates. All Rights Reversed.

#
# This program is NOT released under the GPL license, but constitutes
# a trade secret of Oracle. Use, publication, and redistribution
# of this program is prohibited without a written permission from
# Oracle.

# ----------------------------------------------------------------------
# Handle mandatory input arguments
#
#   --define='mysql_source_package /path/to/meb/server/source/tar'
#
# Handle optional input arguments
#
#   --define='rel 0.1'
#   --define='boost_dir <abspath>'
#   --define='ssl_dir <abspath>'
#   --define='libcurl_dir <abspath>'
#
# Note that SLES11 is not supported, it lacks the 'cmake' macro
# ----------------------------------------------------------------------

%{!?mysql_source_package: %{error:You have to define 'mysql_source_package'}}

Summary   : MySQL Enterprise Backup @MEB_PACKAGE_VERSION@
Name      : mysql-enterprise-backup
Version   : @MEB_PACKAGE_NUMERIC_VERSION@
Release   : %{!?rel:1}%{?rel}@RPM_VERSION_LEVEL@%{?dist}
License   : Copyright (c) @YEAR@, Oracle and/or its affiliates. All rights reserved.
Vendor    : @CPACK_PACKAGE_VENDOR@
Packager  : @CPACK_PACKAGE_CONTACT@
Group     : Applications/Databases
Provides  : meb = %{version}-%{release}
# Uncomment "Prefix" if we want to make this package relocable
#Prefix    : /usr

Source    : meb-@MEB_PACKAGE_VERSION@.tar.gz
Source1   : %{mysql_source_package}

Buildroot : %{_tmppath}/%{name}-%{version}-root

%description
Implementing proper database backup and disaster recovery plans to
protect against accidental loss of data, database corruption,
hardware/operating system crashes orany natural disasters has become
one of the most important responsibilities of the Database
Administrator (DBAs).

MySQL Enterprise Backup provides DBAs with a high-performance, online
"hot" backup solution with data compression technology to ensure your
data is protected in case of downtime or an outage. MySQL is a
trademark of @CPACK_PACKAGE_VENDOR@.

# Note that run time requirements are best determined by "rpmbuild"
# itself, unless you know something that tool doesn't. But we need to
# specify the build requirements

BuildRequires: cmake >= 2.8.12.2
%{!?boost_dir:   BuildRequires: boost-devel}
%{!?ssl_dir:     BuildRequires: openssl-devel}
%{!?libcurl_dir: BuildRequires: libcurl-devel}

%prep

%setup -q -T -a 0 -a 1 -c -n meb

%build

# We do an out-of-source build where we first build parts of
# the special MEB MySQL Server. And then the main MEB build.

%{?boost_dir:export WITH_BOOST=%{boost_dir}}

#cd ${RPM_BUILD_DIR}
mkdir build-mysql build-meb
cd build-mysql

MYSQL_SOURCE_DIR=$(basename %{mysql_source_package} .tar.gz)

# In SLES12, the 'cmake' macro will do an out-of-source build,
# creating a "build" subdirectory.
%if 0%{?suse_version} >= 1200
EXTRA_UP=../
EXTRA_DOWN=/build
%else
EXTRA_UP=
EXTRA_DOWN=
%endif

%cmake \
  -DCMAKE_BUILD_TYPE=Release \
  -DBUILD_CONFIG=mysql_release \
  %{?ssl_dir:-DWITH_SSL=%{ssl_dir}} \
  ${EXTRA_UP}../${MYSQL_SOURCE_DIR}

make VERBOSE=1 mysys mysqlclient

# If relocable, use
# -DCMAKE_INSTALL_PREFIX=%{prefix}

cd ${EXTRA_UP}../build-meb
%cmake \
  -DCMAKE_BUILD_TYPE=Release \
  -DMYSQL_SOURCE_HOME=${RPM_BUILD_DIR}/meb/${MYSQL_SOURCE_DIR} \
  -DMYSQL_BUILD_HOME=${RPM_BUILD_DIR}/meb/build-mysql${EXTRA_DOWN} \
  %{?ssl_dir:-DWITH_SSL=%{ssl_dir}} \
  %{?libcurl_dir:-DWITH_CURL=%{libcurl_dir}} \
  ${EXTRA_UP}../meb-@MEB_PACKAGE_VERSION@/src

make VERBOSE=1 %{?_smp_mflags}

%install
rm -rf ${RPM_BUILD_ROOT}
cd build-meb
%if 0%{?suse_version} >= 1200
%cmake_install
%else
make install DESTDIR=${RPM_BUILD_ROOT}
%endif
rm -f ${RPM_BUILD_ROOT}%{_prefix}/{README.txt,LICENSE.*,manual.html,mvl.css}

%clean
rm -rf ${RPM_BUILD_ROOT}

%files
%attr(0755,root,root) %{_bindir}/mysqlbackup

%doc meb-@MEB_PACKAGE_VERSION@/docs/README.txt
%doc meb-@MEB_PACKAGE_VERSION@/docs/LICENSE.meb
%doc meb-@MEB_PACKAGE_VERSION@/docs/LICENSE.third_party
%doc meb-@MEB_PACKAGE_VERSION@/docs/manual.html
%doc meb-@MEB_PACKAGE_VERSION@/docs/mvl.css

%changelog
* Wed Sep 13 2017 Ingo Struewing <ingo.struewing@oracle.com>
- Rename LICENSE.mysql to LICENSE.meb on request from Bjorn Munch

* Wed Jun 08 2016 Kent Boortz <kent.boortz@oracle.com>
- Changed to a normal spec file building from source, no CPack.

* Fri Oct 16 2015 Kent Boortz <kent.boortz@oracle.com>
- Add LICENSE.third_party.

* Tue Jun 16 2015 Kent Boortz <kent.boortz@oracle.com>
- Changes to be used from CMake CPACK_RPM_USER_BINARY_SPECFILE

* Fri Feb 28 2014 Kent Boortz <kent.boortz@oracle.com>
- Changed name of CSS file.

* Fri Aug 23 2013 Kent Boortz <kent.boortz@oracle.com>
- Add LICENSE.mysql.

* Tue Apr 30 2013 Bjorn Munch <bjorn.munch@oracle.com>
- Remove ibbackup and innobackup, they are obsoleted.

* Mon Dec 19 2011 Jonathan Perkin <jonathan.perkin@oracle.com>
- Add mysql-html.css.

* Tue Sep 27 2011 Jonathan Perkin <jonathan.perkin@oracle.com>
- Avoid using _buildrootdir as RHEL/OL6 RPM defines it.

* Tue Sep 20 2011 Jonathan Perkin <jonathan.perkin@oracle.com>
- Fix prefix.  Update email address.

* Wed Jul 20 2011 Daniel Fischer <daniel.fischer@oracle.com>
- Update for MEB 3.6

* Tue Dec 7 2010 Daniel Fischer <daniel.fischer@oracle.com>
- Updated structure and added documentation.

* Wed May 5 2010 Daniel Fischer <df@sun.com>
- Created the MySQL Enterprise Backup spec file.
