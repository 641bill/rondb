CREATE SCHEMA xtest;
SET GLOBAL mysqlx_connect_timeout = 300;
SET GLOBAL mysqlx_wait_timeout = 300;
SET GLOBAL mysqlx_max_allowed_packet = 1000;

## A. Execute the test with deflate
#

## 1. Send compressed message with invalid payload
#  a. Send compressed-single-frame with too long-uncompressed payload size
#  b. Send compressed-multiple-frame with too long-uncompressed protobuf size
#  c. Send compressed-single-frame with invalid compressed-payload
#  d. Send compressed-multiple-frame with invalid compressed-payload
#  e. Send compressed-group-frame with invalid compressed-payload
## 2. Send compressed message with invalid message
#  a. Send compressed-single-frame with StmtExecute and missing fields (not initialized error)
#  b. Send compressed-single-frame with not know message, and verify that its dispatched
#  c. Send compressed-single-frame with message that exceedes protobufs nested
#     messages limit, and verify that its rejected with proper error
;
# 1.a.
connecting...
active session is now 'SESS_SINGLE1'
RUN recvok
Login OK
Sending 10 bytes raw data...
closing session SESS_SINGLE1
switched to session default
;
# 1.b.
connecting...
active session is now 'SESS_MULTIPLE1'
RUN recvok
Login OK
Sending 27 bytes raw data...
closing session SESS_MULTIPLE1
switched to session default
;
# 1.c.
connecting...
active session is now 'SESS_SINGLE2'
RUN recvok
Login OK
Sending 27 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5171
  msg: "Payload decompression failed"
  sql_state: "HY000"
}

closing session SESS_SINGLE2
switched to session default
;
# 1.d.
connecting...
active session is now 'SESS_MULTIPLE2'
RUN recvok
Login OK
Sending 27 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5171
  msg: "Payload decompression failed"
  sql_state: "HY000"
}

closing session SESS_MULTIPLE2
switched to session default
;
# 1.e.
connecting...
active session is now 'SESS_GROUP1'
RUN recvok
Login OK
Sending 26 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5171
  msg: "Payload decompression failed"
  sql_state: "HY000"
}

closing session SESS_GROUP1
switched to session default
;
# 2.a.
connecting...
active session is now 'SESS_SINGLE3'
RUN recvok
Login OK
Sending 10 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5000
  msg: "Parse error unserializing protobuf message"
  sql_state: "HY000"
}

closing session SESS_SINGLE3
switched to session default
;
# 2.b.
connecting...
active session is now 'SESS_SINGLE4'
RUN recvok
Login OK
send Mysqlx.Expect.Open {
  cond {
    condition_key: 1
  }
}

RUN recvok
Sending 10 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: ERROR
  code: 1047
  msg: "Unexpected message received"
  sql_state: "HY000"
}

Got expected error:
Mysqlx.Error {
  severity: ERROR
  code: 5159
  msg: "Expectation failed: no_error"
  sql_state: "HY000"
}

send Mysqlx.Expect.Close {
}

Got expected error:
Mysqlx.Error {
  severity: ERROR
  code: 5159
  msg: "Expectation failed: no_error"
  sql_state: "HY000"
}


command ok
;
# 2.c.
connecting...
active session is now 'SESS_SINGLE5'
RUN recvok
Login OK

command ok
Try to send number of object more than the X Protocol limit 101 (2 * 51)
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5000
  msg: "X Protocol message recursion limit (100) exceeded"
  sql_state: "HY000"
}

closing session SESS_SINGLE5
switched to session default
Mysqlx.Ok {
  msg: "bye!"
}
ok

## B. Execute the test with lz4
#

## 1. Send compressed message with invalid payload
#  a. Send compressed-single-frame with too long-uncompressed payload size
#  b. Send compressed-multiple-frame with too long-uncompressed protobuf size
#  c. Send compressed-single-frame with invalid compressed-payload
#  d. Send compressed-multiple-frame with invalid compressed-payload
#  e. Send compressed-group-frame with invalid compressed-payload
## 2. Send compressed message with invalid message
#  a. Send compressed-single-frame with StmtExecute and missing fields (not initialized error)
#  b. Send compressed-single-frame with not know message, and verify that its dispatched
#  c. Send compressed-single-frame with message that exceedes protobufs nested
#     messages limit, and verify that its rejected with proper error
;
# 1.a.
connecting...
active session is now 'SESS_SINGLE1'
RUN recvok
Login OK
Sending 10 bytes raw data...
closing session SESS_SINGLE1
switched to session default
;
# 1.b.
connecting...
active session is now 'SESS_MULTIPLE1'
RUN recvok
Login OK
Sending 29 bytes raw data...
closing session SESS_MULTIPLE1
switched to session default
;
# 1.c.
connecting...
active session is now 'SESS_SINGLE2'
RUN recvok
Login OK
Sending 27 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5171
  msg: "Payload decompression failed"
  sql_state: "HY000"
}

closing session SESS_SINGLE2
switched to session default
;
# 1.d.
connecting...
active session is now 'SESS_MULTIPLE2'
RUN recvok
Login OK
Sending 27 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5171
  msg: "Payload decompression failed"
  sql_state: "HY000"
}

closing session SESS_MULTIPLE2
switched to session default
;
# 1.e.
connecting...
active session is now 'SESS_GROUP1'
RUN recvok
Login OK
Sending 26 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5171
  msg: "Payload decompression failed"
  sql_state: "HY000"
}

closing session SESS_GROUP1
switched to session default
;
# 2.a.
connecting...
active session is now 'SESS_SINGLE3'
RUN recvok
Login OK
Sending 10 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5000
  msg: "Parse error unserializing protobuf message"
  sql_state: "HY000"
}

closing session SESS_SINGLE3
switched to session default
;
# 2.b.
connecting...
active session is now 'SESS_SINGLE4'
RUN recvok
Login OK
send Mysqlx.Expect.Open {
  cond {
    condition_key: 1
  }
}

RUN recvok
Sending 10 bytes raw data...
Got expected error:
Mysqlx.Error {
  severity: ERROR
  code: 1047
  msg: "Unexpected message received"
  sql_state: "HY000"
}

Got expected error:
Mysqlx.Error {
  severity: ERROR
  code: 5159
  msg: "Expectation failed: no_error"
  sql_state: "HY000"
}

send Mysqlx.Expect.Close {
}

Got expected error:
Mysqlx.Error {
  severity: ERROR
  code: 5159
  msg: "Expectation failed: no_error"
  sql_state: "HY000"
}


command ok
;
# 2.c.
connecting...
active session is now 'SESS_SINGLE5'
RUN recvok
Login OK

command ok
Try to send number of object more than the X Protocol limit 101 (2 * 51)
Got expected error:
Mysqlx.Error {
  severity: FATAL
  code: 5000
  msg: "X Protocol message recursion limit (100) exceeded"
  sql_state: "HY000"
}

closing session SESS_SINGLE5
switched to session default
Mysqlx.Ok {
  msg: "bye!"
}
ok
SET GLOBAL mysqlx_connect_timeout= DEFAULT;
SET GLOBAL mysqlx_wait_timeout = DEFAULT;
SET GLOBAL mysqlx_max_allowed_packet = DEFAULT;
DROP SCHEMA xtest;
