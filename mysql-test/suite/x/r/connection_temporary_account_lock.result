call mtr.add_suppression('Can not read and process value of User_attributes column from mysql.user table for user');
#
#
# Test of external user attributes update
#
CREATE USER foo@localhost IDENTIFIED BY 'foo';
# Should pass
RUN SELECT current_user() AS 'user check'

user check
foo@localhost
0 rows affected
Mysqlx.Ok {
  msg: "bye!"
}
ok
# Should fail
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: NO) (code 1045)
ok
# Should fail with the same error
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: NO) (code 1045)
ok
UPDATE mysql.user SET user_attributes='{"Password_locking": {"failed_login_attempts": 2, "password_lock_time_days": 2}}' WHERE user='foo';
FLUSH PRIVILEGES;
# Should still fail with policy
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# FR5: Should still fail with policy because of locked
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 2 day(s) (2 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
DROP USER foo@localhost;
#
#
# Test of IDENTIFIED BY and FLUSH PRIVILEGES
#
CREATE USER foo@localhost IDENTIFIED BY 'foo' FAILED_LOGIN_ATTEMPTS 4 PASSWORD_LOCK_TIME 6;
ALTER USER foo@localhost FAILED_LOGIN_ATTEMPTS 2;
ALTER USER foo@localhost PASSWORD_LOCK_TIME 3;
# Should fail with policy
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# Should still fail with policy because of locked
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
ALTER USER foo@localhost IDENTIFIED BY 'foo';
# Should fail locked even after ALTER USER
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
FLUSH PRIVILEGES;
# Should fail unlocked after FLUSH PRIVILEGES
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# Should still fail with policy because of locked
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
# Successful login doesn't work when account is locked.
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
#
#
# Test of ACCOUNT UNLOCK will remove the password failed lock too.
#
ALTER USER foo@localhost ACCOUNT UNLOCK;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# we lock foo user account
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
DROP USER foo@localhost;
#
#
# Test of altering FAILED_LOGIN_ATTEMPTS and PASSWORD_LOCK_TIME equal 0
#
CREATE USER foo@localhost IDENTIFIED BY 'foo' FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 3;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# we lock foo user account
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
ALTER USER foo@localhost FAILED_LOGIN_ATTEMPTS 0;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: NO) (code 1045)
ok
# Should fail as unlocked: tracking turned off by login attempts 0
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: NO) (code 1045)
ok
ALTER USER foo@localhost FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 0;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: NO) (code 1045)
ok
# Should fail as unlocked: tracking turned off by password lock time 0
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: NO) (code 1045)
ok
DROP USER foo@localhost;
#
#
# Test of altering FAILED_LOGIN_ATTEMPTS and PASSWORD_LOCK_TIME
#
CREATE USER foo@localhost IDENTIFIED BY 'foo' FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 3;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# we lock foo user account
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
ALTER USER foo@localhost FAILED_LOGIN_ATTEMPTS 2;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# Should fail as locked
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
ALTER USER foo@localhost PASSWORD_LOCK_TIME 3;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# Should fail as locked
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
DROP USER foo@localhost;
#
#
# Test of a successful login resets the failed count
#
CREATE USER foo@localhost IDENTIFIED BY 'foo' FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 3;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# Should pass
RUN SELECT current_user() AS 'user check'

user check
foo@localhost
0 rows affected
Mysqlx.Ok {
  msg: "bye!"
}
ok
# Should fail as unlocked: the first failure count removed by a connect
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# Should fail as locked
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
DROP USER foo@localhost;
#
#
# Test of password auto-lock and account lock
#
CREATE USER foo@localhost IDENTIFIED BY 'foo' FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 3 ACCOUNT LOCK;
# Should fail with account locked
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is locked. (code 3118)
ok
# Should fail with access denied
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# FR6: Should still fail with policy because of locked
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
DROP USER foo@localhost;
#
#
# Test of check locking and proxies
#
SET GLOBAL check_proxy_users = ON;
SET GLOBAL mysql_native_password_proxy_users = ON;
CREATE USER foo@localhost IDENTIFIED BY 'foo' FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 3;
CREATE USER proxy_foo@localhost IDENTIFIED BY 'proxy_foo' FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 3;
GRANT PROXY ON foo@localhost TO proxy_foo@localhost;
# Should pass
RUN SELECT current_user() AS 'user check'

user check
proxy_foo@localhost
0 rows affected
Mysqlx.Ok {
  msg: "bye!"
}
ok
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'proxy_foo'@'localhost' (using password: YES) (code 10926)
ok
# Should fail as locked
Application terminated with expected error: Access denied for user 'proxy_foo'@'localhost'. Account is blocked for 3 day(s) (3 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
# Should pass: only proxy is locked
RUN SELECT current_user() AS 'user check'

user check
foo@localhost
0 rows affected
Mysqlx.Ok {
  msg: "bye!"
}
ok
# Should fail as unlocked: different user locked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
REVOKE PROXY ON foo@localhost FROM proxy_foo@localhost;
DROP USER foo@localhost, proxy_foo@localhost;
SET GLOBAL check_proxy_users = DEFAULT;
SET GLOBAL mysql_native_password_proxy_users = DEFAULT;
#
#
# Test of ALTER USER ... ACCOUNT UNLOCK
#
CREATE USER foo@localhost IDENTIFIED BY 'foo' FAILED_LOGIN_ATTEMPTS 2 PASSWORD_LOCK_TIME 2;
# Should fail as unlocked
Application terminated with expected error: Access denied for user 'foo'@'localhost' (using password: YES) (code 10926)
ok
# we lock foo user account
Application terminated with expected error: Access denied for user 'foo'@'localhost'. Account is blocked for 2 day(s) (2 day(s) remaining) due to 2 consecutive failed logins. (code 3955)
ok
ALTER  USER   foo@localhost /* ACCOUNT LOCK */   ACCOUNT        UNLOCK;
# Should pass
RUN SELECT current_user() AS 'user check'

user check
foo@localhost
0 rows affected
Mysqlx.Ok {
  msg: "bye!"
}
ok
DROP USER foo@localhost;
