# There are three levels on which the feature is verified:
#
# * on X Protocol layer (without decompressing)
# * confirming that resultset flow is correct
# * confirming that resultset contains correct data
#
# This test confrims that compression works on server side, it does verification
# of result-set data (bullet no 3). The validation is done in result file.
#
#
# Following is verfied:
#
# server->client: CompressSingle|Multiple|Group
#
# In which X Plugin compress by default following messages
#
# * NOTICE - 11, 0x0b
# * RESULTSET_COLUMN_META_DATA - 12, 0x0c
# * RESULTSET_ROW  - 13, 0x0d
# * RESULTSET_FETCH_DONE - 14, 0x0e
#
# followed with uncompressed:
#
# * SQL_STMT_EXECUTE_OK = 17   0x11
#
# The server is going to use following messages to transfer
# compressed payload:
#
# * COMPRESSION_SINGLE = 19;   0x13
#
#
--source include/xplugin_preamble.inc
--source include/xplugin_create_user.inc

## Test starts here
--write_file $MYSQL_TMP_DIR/resultset.tmp
-->import assert_status_variable.macro

-->echo
-->echo
-->echo ## I. Validate simple resultsets
-->echo #
-->echo # 1. Assert resultset for select with single column
-->echo # 2. Assert resultset for select with multiple columns
-->echo # 3. Assert resultset for select with multiple rows
-->echo
-->echo ## II. Validate simple multi-resultsets
-->echo #
-->echo # 1. Assert two resultsets for select queries
-->echo # 2. Assert three resultsets for select queries
-->echo
-->echo ## III. Assert client side status variables
-->echo #
-->echo


-->echo
-->echo #
-->echo # I.1
SELECT 1;
SELECT 1 as "Value";

-->echo
-->echo #
-->echo # I.2
SELECT 1 as "Column1", 2 as "Column2", 3 as "Column3";
SELECT phrase FROM xtest.xtable;
SELECT phrase, prio FROM xtest.xtable;

-->echo
-->echo #
-->echo # II.1
CALL two_resultsets();

-->echo
-->echo #
-->echo # II.2
CALL three_results_sets();


-->echo
-->echo #
-->echo # III
callmacro Assert_client_message_count	COMPRESSION_SINGLE	==	%SINGLE_COUNT%;
callmacro Assert_client_message_count	COMPRESSION_MULTIPLE	==	%MULTIPLE_COUNT%;
callmacro Assert_client_message_count	COMPRESSION_GROUP	==	%GROUP_COUNT%;

EOF

let $STORED_PROC_DB_NAME=xtest;
source ../include/stored_procedures.inc;
source ../include/sample_tables.inc;
SET GLOBAL mysqlx_compression_server_style = "SINGLE,MULTIPLE,GROUP";
CALL recreate_tables();


--echo
--echo ## A. Execute the test using zlib/single
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=deflate
  --compression-client-style= --compression-server-style=single
  -v%SINGLE_COUNT%=59
  -v%MULTIPLE_COUNT%=0
  -v%GROUP_COUNT%=0
  --file=$MYSQL_TMP_DIR/resultset.tmp 2>&1;


--echo
--echo ## B. Execute the test using lz4/single
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=lz4
  --compression-client-style= --compression-server-style=single
  -v%SINGLE_COUNT%=59
  -v%MULTIPLE_COUNT%=0
  -v%GROUP_COUNT%=0
  --file=$MYSQL_TMP_DIR/resultset.tmp 2>&1;


--echo
--echo ## C. Execute the test using zlib/multiple
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=deflate
  --compression-client-style= --compression-server-style=multiple
  -v%SINGLE_COUNT%=0
  -v%MULTIPLE_COUNT%=39
  -v%GROUP_COUNT%=0
  --file=$MYSQL_TMP_DIR/resultset.tmp 2>&1;


--echo
--echo ## D. Execute the test using lz4/multiple
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=lz4
  --compression-client-style= --compression-server-style=multiple
  -v%SINGLE_COUNT%=0
  -v%MULTIPLE_COUNT%=39
  -v%GROUP_COUNT%=0
  --file=$MYSQL_TMP_DIR/resultset.tmp 2>&1;


--echo
--echo ## E. Execute the test using zlib/group
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=deflate
  --compression-client-style= --compression-server-style=group
  -v%SINGLE_COUNT%=0
  -v%MULTIPLE_COUNT%=0
  -v%GROUP_COUNT%=7
  --file=$MYSQL_TMP_DIR/resultset.tmp 2>&1;


--echo
--echo ## F. Execute the test using lz4/group
--echo #

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required --compression-algorithm=lz4
  --compression-client-style= --compression-server-style=group
  -v%SINGLE_COUNT%=0
  -v%MULTIPLE_COUNT%=0
  -v%GROUP_COUNT%=7
  --file=$MYSQL_TMP_DIR/resultset.tmp 2>&1;

## Cleanup
SET GLOBAL mysqlx_compression_server_style = DEFAULT;
DROP SCHEMA xtest;
--remove_file $MYSQL_TMP_DIR/resultset.tmp
--source include/xplugin_drop_user.inc
