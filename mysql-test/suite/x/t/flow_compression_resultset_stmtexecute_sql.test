##
## There are three levels on which the feature is verified:
##
## * on X Protocol layer (without decompressing)
## * confirming that resultset flow is correct
## * confirming that resultset contains correct data
##
## Test of that verifies X Protocol flow for standard SQL queires (after decompression, bullet no 2)

## Preamble
--source include/xplugin_preamble.inc
--source include/xplugin_create_user.inc
## Test starts here

SET GLOBAL mysqlx_compression_server_style = "SINGLE,MULTIPLE,GROUP";
--source ../include/test_flow_resultset_stmtexecute_sql.inc


--echo
--echo ## A. Execute the test using zlib/group
--echo #

call recreate_tables();

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=deflate
  --compression-server-style=group
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## B. Execute the test using zlib/multiple
--echo #

call recreate_tables();

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=deflate
  --compression-server-style=multiple
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## C. Execute the test using zlib/single
--echo #

call recreate_tables();

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=deflate
  --compression-server-style=single
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## D. Execute the test using lz4/group
--echo #

call recreate_tables();

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=lz4
  --compression-server-style=group
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## E. Execute the test using lz4/multiple
--echo #

call recreate_tables();

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=lz4
  --compression-server-style=multiple
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;


--echo
--echo ## F. Execute the test using lz4/single
--echo #

call recreate_tables();

exec $MYSQLXTEST
  -ux_root --password=''
  --schema=xtest
  --compression-mode=required
  --compression-algorithm=lz4
  --compression-server-style=single
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/resultset.xpl 2>&1;

## Cleanup
DROP SCHEMA IF EXISTS xtest;
SET GLOBAL mysqlx_compression_server_style = DEFAULT;
--remove_files_wildcard $MYSQL_TMP_DIR *.xpl
--source include/xplugin_drop_user.inc
