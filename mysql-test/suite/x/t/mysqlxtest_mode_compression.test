## XPLUGIN: Following test verifies compression-mode used by
## both mysqlxclient and mysqlxtest.

--source include/xplugin_preamble.inc
--source include/xplugin_ssl_warnings_suppression.inc
--source include/xplugin_create_user.inc


--write_file $MYSQL_TMP_DIR/compression-none.tmp
-->import assert_status_variable.macro
SELECT "Send some data which might trigger server side compression" as Column1;
-->expecterror 2512
-->begin_compress SINGLE
Mysqlx.Sql.StmtExecute{
  stmt:"SELECT \"some string value\" as column1"
}
-->end_compress

-->expecterror 2512
-->begin_compress MULTIPLE
Mysqlx.Sql.StmtExecute{
  stmt:"SELECT \"some string value\" as column1"
}
-->end_compress

-->expecterror 2512
-->begin_compress GROUP
Mysqlx.Sql.StmtExecute{
  stmt:"SELECT \"some string value\" as column1"
}
-->end_compress

callmacro Assert_client_message_count	COMPRESSION_SINGLE	==	0;
callmacro Assert_client_message_count	COMPRESSION_MULTIPLE	==	0;
callmacro Assert_client_message_count	COMPRESSION_GROUP	==	0;

EOF


--write_file $MYSQL_TMP_DIR/compression-both.tmp
-->import assert_status_variable.macro
SELECT "Send some data which might trigger server side compression" as Column1;
-->begin_compress SINGLE
Mysqlx.Sql.StmtExecute{
  stmt:"SELECT \"some string value\" as column1"
}
-->end_compress
recvresult;

callmacro Assert_client_message_count	COMPRESSION_SINGLE	==	0;
callmacro Assert_client_message_count	COMPRESSION_MULTIPLE	==	0;
callmacro Assert_client_message_count	COMPRESSION_GROUP	>	0;

EOF


--write_file $MYSQL_TMP_DIR/compression-server-only.tmp
-->import assert_status_variable.macro
SELECT "Send some data which might trigger server side compression" as Column1;

# Client compression can't be verified, any usage will drop the connection
callmacro Assert_client_message_count	COMPRESSION_SINGLE	==	0;
callmacro Assert_client_message_count	COMPRESSION_MULTIPLE	==	0;
callmacro Assert_client_message_count	COMPRESSION_GROUP	>	0;

EOF


--write_file $MYSQL_TMP_DIR/compression-client-only.tmp
-->import assert_status_variable.macro
-->begin_compress %OPTION_COMPRESSION_STYLE_CLIENT%
Mysqlx.Sql.StmtExecute{
  stmt:"SELECT \"some string value\" as column1"
}
-->end_compress
-->recvresult
callmacro Assert_client_message_count	COMPRESSION_SINGLE	==	0;
callmacro Assert_client_message_count	COMPRESSION_MULTIPLE	==	0;
callmacro Assert_client_message_count	COMPRESSION_GROUP	==	0;

EOF

--echo
--echo ############################################################
--echo ## Test verifies "--compression-mode" command line option:
--echo #
--echo # 1. Try to use any algorithm with client-single style
--echo #    a. use "DISABLED" compression mode and verify that neither
--echo #       client nor server uses it
--echo #    b. use "REQUIRED" compression mode and verify that client may
--echo #       use the style
--echo #    c. use "PREFERRED" compression mode and verify that client may
--echo #       use the style
--echo # 2. Try to use any algorithm with client-single style, still server
--echo #    disabled all client styles
--echo #    a. use "REQUIRED" compression mode and verify that client can't
--echo #       connect to the server
--echo #    b. use "PREFERRED" compression mode and verify that client may
--echo #       connect to the server, still can't use selected style
--echo # 3. Try to use any algorithm with server-group style
--echo #    a. use "DISABLED" compression mode and verify that neither
--echo #       client nor server uses it
--echo #    b. use "REQUIRED" compression mode and verify that client may
--echo #       use the style
--echo # 4. Try to use any algorithm with server-group style, still server
--echo #    disabled all server styles
--echo #    a. use "REQUIRED" compression mode and verify that client can't
--echo #       connect to the server
--echo #    b. use "PREFERRED" compression mode and verify that client may
--echo #       connect to the server, still can't use selected style
--echo # 5. Try to use any algorithm with server-group and client-single styles
--echo #    a. use "DISABLED" compression mode and verify that neither
--echo #       client nor server uses it
--echo #    b. use "REQUIRED" compression mode and verify that client may
--echo #       use the styles
--echo # 6. Try to use any algorithm with with server-group and client-single styles,
--echo #    still server disabled all client styles
--echo #    a. use "REQUIRED" compression mode and verify that client can't
--echo #       connect to the server
--echo #    b. use "PREFERRED" compression mode and verify that client may
--echo #       connect to the server, still can't use selected style
--echo # 7. Try to use any algorithm with with server-group styles,
--echo #    still server disabled all compression algorithms
--echo #    a. use "REQUIRED" compression mode and verify that client can't
--echo #       connect to the server
--echo #    b. use "PREFERRED" compression mode and verify that client may
--echo #       connect to the server, still can't use compression


--echo
--echo # 1.a
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=DISABLED
  --compression-server-style=
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

--echo
--echo # 1.b
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=REQUIRED
  --compression-server-style=
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-client-only.tmp 2>&1;

--echo
--echo # 1.c
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=PREFERRED
  --compression-server-style=
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-client-only.tmp 2>&1;


--echo
--echo # 2.a
--echo #
SET GLOBAL mysqlx_compression_client_style="";

exec $MYSQLXTEST
  --expect-error=2513
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=REQUIRED
  --compression-server-style=
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

--echo
--echo # 2.b
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=PREFERRED
  --compression-server-style=
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

# Restore the style
SET GLOBAL mysqlx_compression_client_style=DEFAULT;


--echo
--echo # 3.a
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=DISABLED
  --compression-server-style=GROUP
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

--echo
--echo # 3.b
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=REQUIRED
  --compression-server-style=GROUP
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/compression-server-only.tmp 2>&1;


--echo
--echo # 4.a
--echo #
SET GLOBAL mysqlx_compression_server_style="";

exec $MYSQLXTEST
  --expect-error=2513
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=REQUIRED
  --compression-server-style=GROUP
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

--echo
--echo # 4.b
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=PREFERRED
  --compression-server-style=GROUP
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

# Restore the style
SET GLOBAL mysqlx_compression_server_style=DEFAULT;


--echo
--echo # 5.a
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=DISABLED
  --compression-server-style=GROUP
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

--echo
--echo # 5.b
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=REQUIRED
  --compression-server-style=GROUP
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-both.tmp 2>&1;


--echo
--echo # 6.a
--echo #
SET GLOBAL mysqlx_compression_client_style="";

exec $MYSQLXTEST
  --expect-error=2513
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=REQUIRED
  --compression-server-style=GROUP
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

--echo
--echo # 6.b
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=PREFERRED
  --compression-server-style=GROUP
  --compression-client-style=SINGLE
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;

# Restore the style
SET GLOBAL mysqlx_compression_client_style=DEFAULT;


--echo
--echo # 7.a
--echo #
SET GLOBAL mysqlx_compression_algorithms="";

exec $MYSQLXTEST
  --expect-error=2513
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=REQUIRED
  --compression-server-style=GROUP
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/compression-server-only.tmp 2>&1;

--echo
--echo # 7.b
--echo #
exec $MYSQLXTEST
  --user=x_root
  --host=127.0.0.1
  --schema=test
  --ssl-mode=REQUIRED
  --compression-mode=PREFERRED
  --compression-server-style=GROUP
  --compression-client-style=
  --file=$MYSQL_TMP_DIR/compression-none.tmp 2>&1;


## Cleanup
SET GLOBAL mysqlx_compression_client_style=DEFAULT;
SET GLOBAL mysqlx_compression_server_style=DEFAULT;
SET GLOBAL mysqlx_compression_algorithms=DEFAULT;
--remove_file $MYSQL_TMP_DIR/compression-none.tmp
--remove_file $MYSQL_TMP_DIR/compression-both.tmp
--remove_file $MYSQL_TMP_DIR/compression-server-only.tmp
--remove_file $MYSQL_TMP_DIR/compression-client-only.tmp
--source include/xplugin_drop_user.inc
