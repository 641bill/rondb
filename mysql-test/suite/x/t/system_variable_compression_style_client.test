# Test a Mysqlx_compression_client_style system variable by capabilities

--source include/xplugin_preamble.inc
--source include/xplugin_create_user.inc

--write_file $MYSQL_TMP_DIR/capabilities_compression_style_get.xpl
-->import connection.macro
-->callmacro Verify_its_xprotocol_connection

Mysqlx.Connection.CapabilitiesGet {
}
-->recv capabilities[4].value.obj.fld[2]
EOF



--write_file $MYSQL_TMP_DIR/capabilities_compression_style_set.xpl
-->import connection.macro
-->quiet
-->callmacro Verify_its_xprotocol_connection

-->echo compression_style = %VALUE%

Mysqlx.Connection.CapabilitiesSet {
  capabilities {
    capabilities {
      name: "compression"
      value {
        type: OBJECT
        obj {
          fld {
            key: "algorithm"
            value {
              type: SCALAR
              scalar {
                type: V_STRING
                v_string {
                  value: "deflate"
                }
              }
            }
          }
          fld {
            key: "client_style"
            value {
              type: SCALAR
              scalar {
                type: V_STRING
                v_string {
                  value: "%VALUE%"
                }
              }
            }
          }
        }
      }
    }
  }
}
-->recvtype %RESULT%
EOF



--echo ##############################################
--echo ## Mysqlx_compression_client_style = default (single,multiple,group)
--echo

SET GLOBAL Mysqlx_compression_client_style = DEFAULT;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

--echo ##############################################
--echo ## Mysqlx_compression_client_style = single
--echo

SET GLOBAL Mysqlx_compression_client_style = single;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

--echo ##############################################
--echo ## Mysqlx_compression_client_style = multiple
--echo

SET GLOBAL Mysqlx_compression_client_style = multiple;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

--echo ##############################################
--echo ## Mysqlx_compression_client_style = group
--echo

SET GLOBAL Mysqlx_compression_client_style = 'group';

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

--echo ##############################################
--echo ## Mysqlx_compression_client_style = single,multiple
--echo

SET GLOBAL Mysqlx_compression_client_style = 'single,multiple';

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

--echo ##############################################
--echo ## Mysqlx_compression_client_style = single,group
--echo

SET GLOBAL Mysqlx_compression_client_style = 'single,group';

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

--echo ##############################################
--echo ## Mysqlx_compression_client_style = multiple,group
--echo

SET GLOBAL Mysqlx_compression_client_style = 'multiple,group';

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

--echo ##############################################
--echo ## Mysqlx_compression_client_style = single,multiple,group
--echo

SET GLOBAL Mysqlx_compression_client_style = 'single,multiple,group';

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Ok;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

--echo ##############################################
--echo ## Mysqlx_compression_client_style = empty
--echo

SET GLOBAL Mysqlx_compression_client_style = '';

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_get.xpl 2>&1;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=single -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=multiple -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=group -v%RESULT%=Mysqlx.Error;

exec $MYSQLXTEST
  -u x_root --password='' -h127.0.0.1 --no-auth
  --file=$MYSQL_TMP_DIR/capabilities_compression_style_set.xpl 2>&1
  -v%VALUE%=wrong_name -v%RESULT%=Mysqlx.Error;

## Cleanup
SET GLOBAL Mysqlx_compression_client_style = DEFAULT;
--remove_files_wildcard $MYSQL_TMP_DIR *.xpl
--source include/xplugin_drop_user.inc
