#
# Tests for CREATE/ALTER TABLESPACE with AUTOEXTEND_SIZE and MAX_SIZE
# clauses
#
# Test error conditions for CREATE TABLESPACE
CREATE TABLESPACE myspace ADD DATAFILE 'myspace1.ibd' AUTOEXTEND_SIZE 20M MAX_SIZE 10M;
ERROR HY000: AUTOEXTEND_SIZE cannot be greater than the MAX_SIZE
CREATE TABLESPACE myspace ADD DATAFILE 'myspace1.ibd' AUTOEXTEND_SIZE 48k MAX_SIZE 10M;
ERROR HY000: AUTOEXTEND_SIZE value should be between 4M and 64M
CREATE TABLESPACE myspace ADD DATAFILE 'myspace1.ibd' AUTOEXTEND_SIZE 5M MAX_SIZE 10M;
ERROR HY000: AUTOEXTEND_SIZE should be a multiple of 4M
CREATE TABLESPACE myspace ADD DATAFILE 'myspace1.ibd' AUTOEXTEND_SIZE 4M MAX_SIZE 4096;
ERROR HY000: MAX_SIZE value should be greater than 4M
CREATE TABLESPACE myspace ADD DATAFILE 'myspace1.ibd' MAX_SIZE 4096;
ERROR HY000: MAX_SIZE value should be greater than 4M
CREATE TABLESPACE myspace ADD DATAFILE 'myspace1.ibd' AUTOEXTEND_SIZE=8M MAX_SIZE=20M;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	8388608	8388608	20971520
# Test error conditions with ALTER TABLESPACE
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 40M;
ERROR HY000: AUTOEXTEND_SIZE cannot be greater than the MAX_SIZE
ALTER TABLESPACE myspace MAX_SIZE 1M;
ERROR HY000: MAX_SIZE value should be greater than 4M
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 2M;
ERROR HY000: AUTOEXTEND_SIZE value should be between 4M and 64M
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 65M;
ERROR HY000: AUTOEXTEND_SIZE value should be between 4M and 64M
ALTER TABLESPACE myspace MAX_SIZE=0;
ALTER TABLESPACE myspace AUTOEXTEND_SIZE=32M;
ALTER TABLESPACE myspace MAX_SIZE 16M;
ERROR HY000: AUTOEXTEND_SIZE cannot be greater than the MAX_SIZE
ALTER TABLESPACE myspace AUTOEXTEND_SIZE=4M;
ALTER TABLESPACE myspace MAX_SIZE=20M;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	8388608	4194304	20971520
# Validate that the autoextend_size and max_size attributes are persisted properly
# restart
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	8388608	4194304	20971520
DROP TABLESPACE myspace;
# CREATE/ALTER TABLESPACE with AUTOEXTEND_SIZE and MAX_SIZE values set to absolute sizes
# in bytes not qualified with K, M or G
CREATE TABLESPACE myspace ADD DATAFILE 'myspace.ibd' AUTOEXTEND_SIZE 4194304 MAX_SIZE 10000000;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	4194304	4194304	10000000
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 8388608 MAX_SIZE 20000000;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	4194304	8388608	20000000
DROP TABLESPACE myspace;
# CREATE TABLESPACE with autoextend_size > 0 but max_size set to 0
CREATE TABLESPACE myspace AUTOEXTEND_SIZE 4M MAX_SIZE 0;
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 8M MAX_SIZE 4M;
ERROR HY000: AUTOEXTEND_SIZE cannot be greater than the MAX_SIZE
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 4M MAX_SIZE 0;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	4194304	4194304	0
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 0 MAX_SIZE 64M;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	4194304	0	67108864
DROP TABLESPACE myspace;
CREATE TABLESPACE myspace AUTOEXTEND_SIZE 8M MAX_SIZE 20M;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	8388608	8388608	20971520
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 0;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	8388608	0	20971520
ALTER TABLESPACE myspace MAX_SIZE 4M;
ERROR HY000: InnoDB: MAX_SIZE should not be smaller than the tablespace size
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	8388608	0	20971520
ALTER TABLESPACE myspace MAX_SIZE 8M;
DROP TABLESPACE myspace;
CREATE TABLESPACE myspace ADD DATAFILE 'myspace1.ibd';
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	114688	0	0
ALTER TABLESPACE myspace AUTOEXTEND_SIZE=4M MAX_SIZE=20M;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	114688	4194304	20971520
ALTER TABLESPACE myspace AUTOEXTEND_SIZE 0;
ALTER TABLESPACE myspace MAX_SIZE 0;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'myspace';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	114688	0	0
DROP TABLESPACE myspace;
# Validate ALTER TABLESPACE cannot alter AUTOEXTEND_SIZE and MAX_SIZE for a table with
# file_per_tablespace
CREATE TABLE mytable(c1 INT);
ALTER TABLESPACE test.mytable AUTOEXTEND_SIZE=1M;
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '.mytable AUTOEXTEND_SIZE=1M' at line 1
ALTER TABLESPACE test.mytable MAX_SIZE=10M;
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '.mytable MAX_SIZE=10M' at line 1
DROP TABLE mytable;
# CREATE TABLE in a general tablespace with AUTOEXTEND_SIZE and MAX_SIZE attributes
CREATE TABLESPACE myspace ADD DATAFILE 'myspace.ibd';
CREATE TABLE mytable (c1 INT) TABLESPACE myspace AUTOEXTEND_SIZE 4M;
ERROR HY000: InnoDB: "AUTOEXTEND_SIZE" not allowed with general tablespaces
CREATE TABLE mytable (c1 INT) TABLESPACE myspace MAX_SIZE 1M;
ERROR HY000: MAX_SIZE value should be greater than 4M
CREATE TABLE mytable (c1 INT) TABLESPACE myspace MAX_SIZE 10M AUTOEXTEND_SIZE=1M;
ERROR HY000: AUTOEXTEND_SIZE value should be between 4M and 64M
CREATE TABLE mytable (c1 INT) TABLESPACE myspace;
SHOW CREATE TABLE mytable;
Table	Create Table
mytable	CREATE TABLE `mytable` (
  `c1` int DEFAULT NULL
) /*!50100 TABLESPACE `myspace` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
ALTER TABLE mytable AUTOEXTEND_SIZE 8M;
ERROR HY000: InnoDB: "AUTOEXTEND_SIZE" not allowed with general tablespaces
ALTER TABLE mytable MAX_SIZE 20M;
ERROR HY000: InnoDB: "MAX_SIZE" not allowed with general tablespaces
ALTER TABLE mytable MAX_SIZE 10M AUTOEXTEND_SIZE 4M;
ERROR HY000: InnoDB: "AUTOEXTEND_SIZE" not allowed with general tablespaces
SHOW CREATE TABLE mytable;
Table	Create Table
mytable	CREATE TABLE `mytable` (
  `c1` int DEFAULT NULL
) /*!50100 TABLESPACE `myspace` */ ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
DROP TABLE mytable;
DROP TABLESPACE myspace;
# Validate that AUTOEXTEND_SIZE and MAX_SIZE values are effective when the server
# is started with --skip-innodb-validate-tablespace-paths command line option
CREATE TABLESPACE myspace ADD DATAFILE 'myspace.ibd' AUTOEXTEND_SIZE 4M MAX_SIZE 8M;
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME LIKE '%myspace%';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	4194304	4194304	8388608
CREATE TABLE tsp(c1 INT, c2 TEXT) TABLESPACE myspace;
CREATE PROCEDURE bulk_insert()
BEGIN
DECLARE i INT DEFAULT 1;
WHILE i < 10000 DO
INSERT INTO tsp VALUE(i, repeat('aaaaaa', 10000));
COMMIT;
SET i = i + 1;
END WHILE;
END
|
# restart: --skip-innodb-validate-tablespace-paths
call bulk_insert();
ERROR HY000: The table 'tsp' is full
SELECT COUNT(*) FROM tsp;
COUNT(*)
104
SELECT NAME, FILE_SIZE, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME LIKE '%myspace%';
NAME	FILE_SIZE	AUTOEXTEND_SIZE	MAX_SIZE
myspace	8388608	4194304	8388608
DROP PROCEDURE bulk_insert;
DROP TABLE tsp;
DROP TABLESPACE myspace;
# restart
# Validate AUTOEXTEND_SIZE and MAX_SIZE are not supported on system tablespace
# Validate that CREATE TABLE returns error when the table is created with
# AUTOEXTEND_SIZE or MAX_SIZE attributes on a system tablespace
# Set the default tablespace as a system tablespace
SET GLOBAL innodb_file_per_table=0;
CREATE TABLE tsystem(c1 INT) ENGINE=InnoDB AUTOEXTEND_SIZE 4M;
ERROR HY000: InnoDB : AUTOEXTEND_SIZE is not accepted for system tablespace.
CREATE TABLE tsystem(c1 INT) ENGINE=InnoDB MAX_SIZE 40M;
ERROR HY000: InnoDB : MAX_SIZE is not accepted for system tablespace.
CREATE TABLE tsystem(c1 INT) ENGINE=InnoDB AUTOEXTEND_SIZE 4M MAX_SIZE 40M;
ERROR HY000: InnoDB : AUTOEXTEND_SIZE is not accepted for system tablespace.
# Validate that an error is returned when a table with AUTOEXTEND_SIZE or MAX_SIZE
# attribute is moved to a system tablespace
SET GLOBAL innodb_file_per_table=1;
CREATE TABLE tsystem1 (c1 INT) ENGINE=InnoDB AUTOEXTEND_SIZE 4M;
CREATE TABLE tsystem2 (c1 INT) ENGINE=InnoDB MAX_SIZE 20M;
SET GLOBAL innodb_file_per_table=0;
ALTER TABLE tsystem1 TABLESPACE innodb_system;
ERROR HY000: InnoDB : AUTOEXTEND_SIZE is not accepted for system tablespace.
ALTER TABLE tsystem2 TABLESPACE innodb_system;
ERROR HY000: InnoDB : MAX_SIZE is not accepted for system tablespace.
ALTER TABLE tsystem1 AUTOEXTEND_SIZE 0;
ALTER TABLE tsystem2 MAX_SIZE 0;
ALTER TABLE tsystem1 TABLESPACE innodb_system;
ALTER TABLE tsystem2 TABLESPACE innodb_system;
DROP TABLE tsystem1;
DROP TABLE tsystem2;
SET GLOBAL innodb_file_per_table=1;
# Validate AUTOEXTEND_SIZE and MAX_SIZE options work for the data dictionary
# tablespace mysql
SELECT NAME, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'mysql';
NAME	AUTOEXTEND_SIZE	MAX_SIZE
mysql	0	0
ALTER TABLESPACE mysql AUTOEXTEND_SIZE 4M MAX_SIZE 400M;
SELECT NAME, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'mysql';
NAME	AUTOEXTEND_SIZE	MAX_SIZE
mysql	4194304	419430400
ALTER TABLESPACE mysql AUTOEXTEND_SIZE 0 MAX_SIZE 0;
SELECT NAME, AUTOEXTEND_SIZE, MAX_SIZE FROM information_schema.innodb_tablespaces
WHERE NAME = 'mysql';
NAME	AUTOEXTEND_SIZE	MAX_SIZE
mysql	0	0
# Validate that autoextend_size and max_size are not supported for
# innodb_temporary and undo tablespaces
CREATE UNDO TABLESPACE undotest ADD DATAFILE 'undotest.ibu' AUTOEXTEND_SIZE 4M;
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'AUTOEXTEND_SIZE 4M' at line 1
CREATE UNDO TABLESPACE undotest ADD DATAFILE 'undotest.ibu' MAX_SIZE 400M;
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MAX_SIZE 400M' at line 1
ALTER TABLESPACE innodb_undo_001 AUTOEXTEND_SIZE 4M;
ERROR 42000: InnoDB: Tablespace names starting with `innodb_` are reserved.
ALTER TABLESPACE innodb_undo_001 MAX_SIZE 40M;
ERROR 42000: InnoDB: Tablespace names starting with `innodb_` are reserved.
ALTER TABLESPACE innodb_temporary AUTOEXTEND_SIZE 4M;
ERROR 42000: InnoDB: `innodb_temporary` is a reserved tablespace name.
ALTER TABLESPACE innodb_temporary MAX_SIZE 40M;
ERROR 42000: InnoDB: `innodb_temporary` is a reserved tablespace name.
