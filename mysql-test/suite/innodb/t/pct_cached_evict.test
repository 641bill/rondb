#
# Confirm that evicting a page from the buffer pool accounts it correctly
# in the stats for how much pages per index are cached.
#

-- source include/have_innodb.inc

let $get_n_cached_pages=
SELECT cached.n_cached_pages AS n_cached_pages
FROM
information_schema.innodb_cached_indexes AS cached,
information_schema.innodb_sys_indexes AS indexes,
information_schema.innodb_sys_tables AS tables
WHERE
cached.index_id = indexes.index_id
AND cached.space_id = indexes.space
AND indexes.table_id = tables.table_id
AND tables.name LIKE '%pct_cached_evict';
CREATE TABLE pct_cached_evict (a TEXT) ENGINE=INNODB;

-- disable_query_log
-- echo # Populating pct_cached_evict with a few pages
BEGIN;
-- let $i = 64
while ($i)
{
        INSERT INTO pct_cached_evict VALUES (REPEAT('a', 1024));
        dec $i;
}
COMMIT;
-- enable_query_log

-- let $before_evict = `$get_n_cached_pages`

-- source suite/innodb/include/evict_everything_from_buffer_pool.inc

-- let $after_evict = `$get_n_cached_pages`

-- disable_query_log
-- eval SELECT $after_evict < $before_evict AS decreased
-- enable_query_log

DROP TABLE pct_cached_evict;
