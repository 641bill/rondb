--source include/have_innodb_16k.inc
# Test for BUG #33459653: Coredump after add index for partion table with ibd file missing.


let $MYSQLD_DATADIR=`SELECT @@datadir`;

CREATE TABLE table_33459653(ID INT NOT NULL AUTO_INCREMENT, Random INT NOT
NULL, Text VARCHAR(200) NOT NULL, PRIMARY KEY(id))
ENGINE=InnoDB DEFAULT CHARSET=UTF8MB4 PARTITION BY RANGE (id) (
PARTITION p1 VALUES LESS THAN (2000),
PARTITION p2 VALUES LESS THAN (4000),
PARTITION p3 VALUES LESS THAN (6000),
PARTITION p4 VALUES LESS THAN MAXVALUE);

--source include/shutdown_mysqld.inc

# DELETE p4's .ibd file
--remove_file $MYSQLD_DATADIR/test/table_33459653#p#p4.ibd

# Restart the server
--source include/start_mysqld.inc

--disable_query_log
call mtr.add_suppression("\\[ERROR\\] .*MY-\\d+.* Operating system error number 2 in a file operation.");
call mtr.add_suppression("\\[ERROR\\] .*MY-\\d+.* The error means the system cannot find the path specified.");
call mtr.add_suppression("\\[ERROR\\] .*MY-\\d+.* If you are installing InnoDB, remember that you must create directories yourself, InnoDB does not create them.");
call mtr.add_suppression("\\[ERROR\\] .*MY-\\d+.* Failed to find tablespace for table `\.\.*`\.`\.\.*` .* in the cache.");
call mtr.add_suppression("\\[ERROR\\] .*MY-\\d+.* Cannot open datafile for read-only");
call mtr.add_suppression("\\[ERROR\\] .*MY-\\d+.* Could not find a valid tablespace file for");
call mtr.add_suppression("\\[Warning\\] .*MY-\\d+.* Ignoring tablespace .* because it could not be opened");
call mtr.add_suppression("\\[Warning\\] .*MY-\\d+.* Cannot calculate statistics for table `\.\.*`\.`\.\.*` .* because the \.ibd file is missing");
call mtr.add_suppression("\\[Warning\\] .*MY-\\d+.* Tablespace .*, name '.*', file '.*' is missing!");
--enable_query_log

--error S42S02
ALTER TABLE table_33459653 ADD INDEX index1(Random);


--error S42S02
SELECT * FROM table_33459653 WHERE Random=1;

DROP TABLE table_33459653;
