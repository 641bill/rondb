# ********************************************************************
# wl#8619 : Test the functionality of portability to a different OS
# Check windows --datadir and tablespaces on Linx (posix compliant) OS
# Inorder to run this testcase tablespace_portable_win.zip file should
# exist in the suite/innodb/t. The above zip file have to be created
# by using the Win server and take the zip file.
# For more info check README_portability_tablespace_linx.txt
# ********************************************************************
--source include/have_innodb_max_16k.inc
--source include/not_valgrind.inc

--echo # Skip other platfoms and run only on Linux.
if (`select convert(@@version_compile_os using latin1) IN ("Linux") = 0`)
{
  skip Need Linux;
}

let $MYSQLD_OLD_DATADIR = `select @@datadir`;

CREATE TABLE tab(c1 int);

INSERT INTO tab VALUES(10);

--echo # copy the win datadir zip into destination location
--copy_file $MYSQL_TEST_DIR/suite/innodb/t/tablespace_portable_win.zip $MYSQL_TMP_DIR/tablespace_portable_win.zip

--echo # Unzip the zip file.
--exec unzip -qo $MYSQL_TMP_DIR/tablespace_portable_win.zip -d $MYSQL_TMP_DIR

--echo ## Stop DB server
--source include/shutdown_mysqld.inc

--echo ## Start winDB with --innodb-directories
let $innodb_dirs='$MYSQL_TMP_DIR/datadir1;$MYSQL_TMP_DIR/undo_files;$MYSQL_TMP_DIR/part0;$MYSQL_TMP_DIR/part1;$MYSQL_TMP_DIR/part2;$MYSQL_TMP_DIR/part3';
--let $restart_parameters=restart: --datadir=$MYSQL_TMP_DIR/win-DB --innodb_undo_directory=$MYSQL_TMP_DIR/undo_files --innodb_data_home_dir=$MYSQL_TMP_DIR/data_home --innodb_undo_tablespaces=5 --innodb_log_files_in_group=4 --innodb_log_group_home_dir=$MYSQL_TMP_DIR/data_home --innodb_data_file_path=data01:20M;data02:20M:autoextend --lower_case_table_names=1 --log_error_verbosity=3 --innodb-directories=$innodb_dirs
--source include/start_mysqld_no_echo.inc

--echo ## Check new datadir
--replace_result $MYSQL_TMP_DIR NEW_DATADIR
SELECT @@datadir;

--replace_result $MYSQL_TMP_DIR UNDO_FILES
SELECT @@innodb_undo_directory;

--replace_result $MYSQL_TMP_DIR DATA_HOME
SELECT @@innodb_data_home_dir;

--replace_result $MYSQL_TMP_DIR DATA_HOME_DIR
SELECT @@innodb_log_group_home_dir;

SELECT @@innodb_data_file_path;

SELECT @@innodb_undo_tablespaces;

--replace_result $MYSQL_TMP_DIR db_directory1
SHOW CREATE TABLE tab3;

--replace_result $MYSQL_TMP_DIR db_directory1
SHOW CREATE TABLE purchase;

--disable_warnings

# server was crashing here with ha_innodb.cc != nullptr
--replace_column 1 #
SELECT TABLESPACE_NAME,FILE_TYPE,TABLE_NAME,ENGINE FROM INFORMATION_SCHEMA.FILES;

--echo ## Stop DB server
--source include/shutdown_mysqld.inc

--echo ## restart the server with --datadir and without scan DIR option
--let $restart_parameters=restart: --datadir=$MYSQL_TMP_DIR/win-DB --innodb_undo_directory=$MYSQL_TMP_DIR/undo_files --innodb_data_home_dir=$MYSQL_TMP_DIR/data_home --innodb_undo_tablespaces=5 --innodb_log_files_in_group=4 --innodb_log_group_home_dir=$MYSQL_TMP_DIR/data_home --innodb_data_file_path=data01:20M;data02:20M:autoextend --log_error_verbosity=3 --lower_case_table_names=1
--source include/start_mysqld_no_echo.inc

--echo ## Check new datadir
--replace_result $MYSQL_TMP_DIR NEW_DATADIR
SELECT @@datadir;

--replace_result $MYSQL_TMP_DIR UNDO_FILES
SELECT @@innodb_undo_directory;

--replace_result $MYSQL_TMP_DIR DATA_HOME
SELECT @@innodb_data_home_dir;

--replace_result $MYSQL_TMP_DIR DATA_HOME_DIR
SELECT @@innodb_log_group_home_dir;

SELECT @@innodb_data_file_path;

SELECT @@innodb_undo_tablespaces;

--replace_result $MYSQL_TMP_DIR db_directory1
SHOW CREATE TABLE tab3;

SHOW CREATE TABLE tab4;

--replace_result $MYSQL_TMP_DIR db_directory1
SHOW CREATE TABLE purchase;

--echo ## Check with DML & DDL operations
SELECT * FROM tab1;

SELECT * FROM tab2;

SELECT * FROM tab3;

DELETE FROM tab1;

DELETE FROM tab2;

DELETE FROM tab3;

DELETE FROM tab4;

# Server throws error Got error 44 - 'InnoDB error' to be fixed
#ALTER TABLE tab3 ADD COLUMN c3 VARCHAR(15);

ALTER TABLE tab4 ADD COLUMN c3 VARCHAR(15);

INSERT INTO tab1 VALUES(1, 'VISH');

INSERT INTO tab2 VALUES(2, 'VISH');

INSERT INTO tab3 VALUES (100,'VISWANATH',100);

INSERT INTO tab3 VALUES (300,'VISWANATH',100);

INSERT INTO tab4 VALUES(2, 'VISH', 'NATH');

SELECT * FROM tab1;

SELECT * FROM tab2;

SELECT * FROM tab3;

SELECT * FROM tab4;

# clean up
DROP TABLE tab1;

DROP TABLE tab2;

DROP TABLE tab3;

DROP TABLE tab4;

DROP TABLE purchase;

DROP TABLESPACE ts2;

--echo ## Stop DB server
--source include/shutdown_mysqld.inc

--echo ## Cleanup the Windows --datadir location and its *.ibd file location
--remove_files_wildcard $MYSQL_TMP_DIR/data_home/ data*
--remove_files_wildcard $MYSQL_TMP_DIR/data_home/ ib_buffer*
--remove_files_wildcard $MYSQL_TMP_DIR/data_home/ ib_log*
--remove_files_wildcard $MYSQL_TMP_DIR/data_home/ ibtmp*
--rmdir $MYSQL_TMP_DIR/data_home

--remove_files_wildcard $MYSQL_TMP_DIR/undo_files/ undo*
--rmdir  $MYSQL_TMP_DIR/undo_files/test
--rmdir  $MYSQL_TMP_DIR/undo_files

--rmdir $MYSQL_TMP_DIR/datadir1/test
--rmdir $MYSQL_TMP_DIR/datadir1
--rmdir $MYSQL_TMP_DIR/part0/test
--rmdir $MYSQL_TMP_DIR/part1/test
--rmdir $MYSQL_TMP_DIR/part2/test
--rmdir $MYSQL_TMP_DIR/part3/test
--rmdir $MYSQL_TMP_DIR/part0
--rmdir $MYSQL_TMP_DIR/part1
--rmdir $MYSQL_TMP_DIR/part2
--rmdir $MYSQL_TMP_DIR/part3

--remove_files_wildcard $MYSQL_TMP_DIR/win-DB/test/ *
--remove_files_wildcard $MYSQL_TMP_DIR/win-DB/sys/ *
--remove_files_wildcard $MYSQL_TMP_DIR/win-DB/mysql/ *
--remove_files_wildcard $MYSQL_TMP_DIR/win-DB/performance_schema/ *
--rmdir $MYSQL_TMP_DIR/win-DB/mysql
--rmdir $MYSQL_TMP_DIR/win-DB/sys
--rmdir $MYSQL_TMP_DIR/win-DB/test
--rmdir $MYSQL_TMP_DIR/win-DB/performance_schema
--remove_files_wildcard $MYSQL_TMP_DIR/win-DB/ *
--rmdir $MYSQL_TMP_DIR/win-DB
--remove_files_wildcard $MYSQL_TMP_DIR/ tablespace_portable_win.zip

--replace_result $MYSQLD_OLD_DATADIR OLD_DATADIR
--let $restart_parameters="restart: --datadir=$MYSQLD_OLD_DATADIR"
--source include/start_mysqld.inc

--replace_result $MYSQLD_OLD_DATADIR OLD_DATADIR
SELECT @@datadir;

SELECT * FROM tab;

DROP TABLE tab;

call mtr.add_suppression("\\[Warning\\] \\[[^]]*\\] InnoDB: Tablespace 'innodb_system' filename is unknown. Use \\--innodb-directories to locate of the file.");
