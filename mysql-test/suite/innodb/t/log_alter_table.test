--source include/have_innodb.inc
--source include/have_debug.inc

# Embedded server does not support crashing
--source include/not_embedded.inc

--echo #
--echo # Bug#21796691 INNODB REDO LOG DOES NOT INDICATE WHEN
--echo # REDO LOGGING IS SKIPPED
--echo #
CREATE TABLE t1 (a INT NOT NULL, b INT UNIQUE) ENGINE=InnoDB;
# MLOG_INDEX_LOAD will not be emitted for empty tables. Insert a row.
INSERT INTO t1 VALUES (1,2);
--source include/no_checkpoint_start.inc
# We should get two MLOG_INDEX_LOAD for this.
ALTER TABLE t1 ADD PRIMARY KEY(a), ALGORITHM=INPLACE;
# And one MLOG_INDEX_LOAD for this.
ALTER TABLE t1 DROP INDEX b, ADD INDEX (b);

--let CLEANUP_IF_CHECKPOINT=DROP TABLE t1;
--source include/no_checkpoint_end.inc

--let $restart_parameters = restart: --debug=d,ib_log
--source include/start_mysqld.inc

# Look for at least one MLOG_INDEX_LOAD in the error log.
# Theoretically, it may have been written by this test or an earlier test.
# FIXME: redirect the error log of the restart to a new file,
# and ensure that we have the exact number of records there.
let SEARCH_FILE = $MYSQLTEST_VARDIR/log/mysqld.1.err;
let SEARCH_PATTERN=scan .*: log rec MLOG_INDEX_LOAD;
--source include/search_pattern_in_file.inc

CHECK TABLE t1;

# Remove the --debug=d,ib_log setting.
--let $restart_parameters = restart;
--source include/restart_mysqld.inc

DROP TABLE t1;
