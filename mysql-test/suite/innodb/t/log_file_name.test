--echo # Test tablespace discovery during crash recovery
--echo # including the detection of duplicate and missing tablespaces

--source include/have_innodb_max_16k.inc

--source include/have_debug.inc
--source include/not_valgrind.inc

let MYSQLD_DATADIR= `select @@datadir`;
let SEARCH_FILE= $MYSQLTEST_VARDIR/tmp/my_restart.err;
let $mysqld=$MYSQLD_CMD --core-file --console > $SEARCH_FILE 2>&1;

--echo # Clear old log file
--source include/shutdown_mysqld.inc
--move_file $MYSQLTEST_VARDIR/log/mysqld.1.err $MYSQLTEST_VARDIR/tmp/mysqld_00.log
--source include/start_mysqld.inc

-- echo # Do up some DDL and DML to recover
SET GLOBAL innodb_file_per_table=ON;
SET GLOBAL innodb_master_thread_disabled_debug=1;

CREATE TABLE t1(a INT PRIMARY KEY) ENGINE=InnoDB;

# We want to force full recovery
SET GLOBAL innodb_checkpoint_disabled=1;

BEGIN;
INSERT INTO t1 VALUES (1964),(12),(25);
UPDATE t1 SET a=2000 where a=1964;
COMMIT;

--source include/kill_mysqld.inc

--move_file $MYSQLTEST_VARDIR/log/mysqld.1.err $MYSQLTEST_VARDIR/tmp/mysqld_01.log

--echo # Server should never start when there are files with duplicate space IDs
--echo # Fault 1 tblespace files with duplicate space_id.
--copy_file $MYSQLD_DATADIR/test/t1.ibd $MYSQLD_DATADIR/test/t2.ibd

--echo # Attempt to start mysqld. Recovery will fail - duplicate space ID
--error 1,42
--exec $mysqld

let SEARCH_PATTERN= \[ERROR\] InnoDB: Multiple files found for the same tablespace ID.*;
--source include/search_pattern_in_file.inc

let SEARCH_PATTERN= \[ERROR\] InnoDB: Tablespace ID: \d+ =.*\['.*t1.ibd', '.*t2.ibd'\].*;
--source include/search_pattern_in_file.inc

--move_file $SEARCH_FILE $MYSQLTEST_VARDIR/tmp/mysqld_02.log

--echo # Remove files with duplicate space ID from fault 1
--remove_file $MYSQLD_DATADIR/test/t2.ibd

--echo # Should startup fine
--source include/start_mysqld.inc

DROP TABLE t1;

CREATE TABLE t1(a INT PRIMARY KEY) ENGINE=InnoDB;

# We want to force full recovery
SET GLOBAL innodb_checkpoint_disabled=1;

BEGIN;
INSERT INTO t1 VALUES (1964),(12),(25);
COMMIT;

--source include/kill_mysqld.inc

--move_file $MYSQLD_DATADIR/test/t1.ibd $MYSQLD_DATADIR/test/t1.ibt

--echo # Fault 2: Dirty tablespaces with missing files

--echo # Attempt to start mysqld. Recovery will fail, missing tablespace file
--error 1,42
--exec $mysqld

let SEARCH_PATTERN= \[ERROR\] InnoDB: Could not find any file associated with the tablespace ID:.*\d+;
--source include/search_pattern_in_file.inc

--move_file $SEARCH_FILE $MYSQLTEST_VARDIR/tmp/mysqld_03.log

--echo # Fault 3: Empty data file

# Create an empty t1.ibd
--exec echo "" > $MYSQLD_DATADIR/test/t1.ibd

--echo # Attempt to start mysqld. Recovery will fail
--error 1,42
--exec $mysqld

--echo # Restore t1.ibd
--remove_file $MYSQLD_DATADIR/test/t1.ibd
--move_file $MYSQLD_DATADIR/test/t1.ibt $MYSQLD_DATADIR/test/t1.ibd

--source include/start_mysqld.inc

SELECT * FROM t1;
SHOW TABLES;
DROP TABLE t1;

# We want to force full recovery
SET GLOBAL innodb_master_thread_disabled_debug=1;
SET GLOBAL innodb_checkpoint_disabled=1;

CREATE TABLE t1(a INT PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t1 VALUES(2008), (08), (25);

--source include/kill_mysqld.inc

--remove_file $MYSQLD_DATADIR/test/t1.ibd

--move_file $MYSQLTEST_VARDIR/log/mysqld.1.err $MYSQLTEST_VARDIR/tmp/mysqld_04.log

--echo # Make the header page of t1.ibd consists of zero bytes
perl;
die unless open(FILE, ">$ENV{MYSQLD_DATADIR}/test/t1.ibd");
print FILE "\0" x 16384;
close(FILE);
EOF

--echo ".ibd files cannot have a space id of 0"
--error 1,42
--exec $mysqld

let SEARCH_PATTERN= \[Warning\] InnoDB:.*Ignoring.*t1.ibd.*invalid.*ID.*;
--source include/search_pattern_in_file.inc

--move_file $SEARCH_FILE $MYSQLTEST_VARDIR/tmp/mysqld_05.log

--remove_file $MYSQLD_DATADIR/test/t1.ibd
 
--error 1,42
--exec $mysqld --innodb-force-recovery=1 --innodb-nonexistent-option

let SEARCH_PATTERN= \[ERROR\] unknown option '--innodb-nonexistent-option';
--source include/search_pattern_in_file.inc

--echo # Should startup fine
--source include/start_mysqld.inc

DROP TABLE t1;

--echo # List of files:
--list_files $MYSQLD_DATADIR/test

SHOW TABLES;
SELECT * FROM INFORMATION_SCHEMA.INNODB_TABLES
WHERE NAME NOT LIKE 'SYS_%' AND NAME NOT LIKE 'sys/%' AND NAME NOT LIKE 'mysql/%';
