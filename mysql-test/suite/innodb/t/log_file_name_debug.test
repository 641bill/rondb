--source include/have_innodb.inc
# Embedded server does not support restarting
--source include/not_embedded.inc
--source include/have_debug.inc

--echo #
--echo # Bug#19685095 DO NOT CARE ABOUT UNRESOLVED MLOG_FILE_NAME
--echo # IF THERE ARE NO OPERATIONS TO APPLY
--echo #

SET GLOBAL DEBUG='+d,fil_names_write_bogus';

let MYSQLD_DATADIR= `select @@datadir`;
--replace_regex /.*Last checkpoint at[[:space:]]*([0-9]+).*/\1/gso
let CHECKPOINT_LSN=`SHOW ENGINE INNODB STATUS`;

CREATE TABLE t1(a INT PRIMARY KEY) ENGINE=InnoDB;
--source include/kill_mysqld.inc

# Check that the latest checkpoint in the redo log files
# is not newer than our checkpoint.
perl;
my $cp = $ENV{CHECKPOINT_LSN};
$cp =~ s/^InnoDB\t\t//;
my $log = "$ENV{MYSQLD_DATADIR}ib_logfile0";
open(LOG, "<$log") || die "Unable to open $log";
seek(LOG, 512, 0) || die "Unable to seek $log";
die unless read(LOG, $_, 16) == 16;
my ($no1hi,$no1lo,$cp1hi,$cp1lo) = unpack("N*", $_);
seek(LOG, 3 * 512, 0) || die "Unable to seek $log";
die unless read(LOG, $_, 16) == 16;
my ($no2hi,$no2lo,$cp2hi,$cp2lo) = unpack("N*", $_);
close(LOG);

my $cp1 = $cp1hi << 32 | $cp1lo;
my $cp2 = $cp2hi << 32 | $cp2lo;

open(OUT, ">$ENV{MYSQLTEST_VARDIR}/log/check.txt") || die;

if ($cp1 > $cp || $cp2 > $cp) {
   print OUT "--source include/start_mysqld.inc\n";
   print OUT "DROP TABLE t1;\n";
   print OUT "--skip Extra checkpoint 1 after $cp";
   print OUT " ($no1hi:$no1lo=$cp1,$no2hi:$no2lo=$cp2)\n";
}

close(OUT);
EOF

--source $MYSQLTEST_VARDIR/log/check.txt
--remove_file $MYSQLTEST_VARDIR/log/check.txt

--source include/start_mysqld.inc

DROP TABLE t1;

let SEARCH_FILE = $MYSQLTEST_VARDIR/log/mysqld.1.err;
let SEARCH_PATTERN = InnoDB: Tablespace 4294967280 was not found at .*, but there were no modifications either;
--source include/search_pattern.inc
