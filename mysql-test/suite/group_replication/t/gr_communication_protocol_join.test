###############################################################################
# WL#11610
# Perform some simple tests about communication_protocol_join.
#
# This test uses 2 servers M1, M2.
# M1 -> server1,  M2 -> server2
#
# Test:
# 1. Start 2 servers and add them into group replication
# 2. 2. Verify error when setting group_replication_communication_protocol_join
#    to invalid value type on M2
# 3. Verify M2 fails to START GROUP_REPLICATION with invalid
#    group_replication_communication_protocol_join
# 4. Cleanup
################################################################################
--source include/have_group_replication_plugin.inc
--let $rpl_server_count= 2
--source include/group_replication.inc

# Suppress expected error
--let $rpl_connection_name= server2
--source include/rpl_connection.inc
SET SESSION sql_log_bin= 0;
call mtr.add_suppression(".* is an invalid value for group_replication_communication_protocol_join.*");
call mtr.add_suppression("Error on group communication engine initialization");
call mtr.add_suppression("Error calling group communication interfaces while trying to leave the group");
SET SESSION sql_log_bin= 1;

--echo ###############################################################################
--echo # 2. Verify error when setting group_replication_communication_protocol_join to invalid value type on M3
--error ER_WRONG_TYPE_FOR_VAR
SET GLOBAL group_replication_communication_protocol_join = 1;

--echo ###############################################################################
--echo # 3. Verify M3 fails to START GROUP_REPLICATION with invalid group_replication_communication_protocol_join
--source include/stop_group_replication.inc

SET GLOBAL group_replication_communication_protocol_join=" ";
--error ER_GROUP_REPLICATION_COMMUNICATION_LAYER_SESSION_ERROR
START GROUP_REPLICATION;

SET GLOBAL group_replication_communication_protocol_join="5";
--error ER_GROUP_REPLICATION_COMMUNICATION_LAYER_SESSION_ERROR
START GROUP_REPLICATION;

SET GLOBAL group_replication_communication_protocol_join="5.7";
--error ER_GROUP_REPLICATION_COMMUNICATION_LAYER_SESSION_ERROR
START GROUP_REPLICATION;

SET GLOBAL group_replication_communication_protocol_join="5.7.14a";
--error ER_GROUP_REPLICATION_COMMUNICATION_LAYER_SESSION_ERROR
START GROUP_REPLICATION;

SET GLOBAL group_replication_communication_protocol_join="5.7.13";
--error ER_GROUP_REPLICATION_COMMUNICATION_LAYER_SESSION_ERROR
START GROUP_REPLICATION;

SET GLOBAL group_replication_communication_protocol_join="99.99.99";
--error ER_GROUP_REPLICATION_COMMUNICATION_LAYER_SESSION_ERROR
START GROUP_REPLICATION;

--echo ###############################################################################
--echo # 4. Cleanup
SET GLOBAL group_replication_communication_protocol_join= default;

--source include/start_group_replication.inc

--let $rpl_connection_name= server1
--source include/rpl_connection.inc

--source include/group_replication_end.inc
