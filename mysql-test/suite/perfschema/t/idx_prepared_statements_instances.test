# Tests for PERFORMANCE_SCHEMA

--source include/not_embedded.inc
--source include/have_perfschema.inc

# Setup

delimiter //;

create procedure proc1(a int, b int)
BEGIN
  prepare st1 from 'SELECT SQRT(POW(?,2) + POW(?,2)) AS hypotenuse';
  execute st1 using @a, @b;
END //

delimiter ;//

SET @a = 3;
SET @b = 4;
call proc1(@a, @b);

select OBJECT_INSTANCE_BEGIN, STATEMENT_ID, STATEMENT_NAME,
       OWNER_THREAD_ID, OWNER_EVENT_ID,
       OWNER_OBJECT_TYPE, OWNER_OBJECT_SCHEMA, OWNER_OBJECT_NAME
  from performance_schema.prepared_statements_instances
  limit 1
  into @oib, @stmt_id, @stmt_name, @o_tid, @o_eid,
       @o_otype, @o_oschema, @o_oname;

--disable_warnings
###########################################################################
# Test index on OBJECT_INSTANCE_BEGIN
###########################################################################

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OBJECT_INSTANCE_BEGIN = '0000000';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OBJECT_INSTANCE_BEGIN > 0 ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OBJECT_INSTANCE_BEGIN < 0 ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OBJECT_INSTANCE_BEGIN = @oib ;

--echo ############# Explain End #########################################
--enable_warnings

flush status;

--replace_column 1 #
select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OBJECT_INSTANCE_BEGIN = @oib ;

# Handler counts verified in idx_compare
#show session status like "handler_read%";

###########################################################################
# Test index on STATEMENT_ID
###########################################################################

--disable_warnings
--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_ID = '9999';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_ID > '9999' ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_ID < '1' ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_ID = @stmt_id ;

--echo ############# Explain End #########################################
--enable_warnings

flush status;

--replace_column 1 #
select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_ID = @stmt_id ;

#show session status like "handler_read%";

###########################################################################
# Test index on STATEMENT_NAME
###########################################################################

--disable_warnings
--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_NAME = "impossible";

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_NAME > "foo" ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_NAME < "bar" ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_NAME = @stmt_name ;

--echo ############# Explain End #########################################
--enable_warnings

flush status;

--replace_column 1 #
select SUM_ERRORS from performance_schema.prepared_statements_instances
  where STATEMENT_NAME = @stmt_name ;

#show session status like "handler_read%";

###########################################################################
# Test index on OWNER_THREAD_ID, OWNER_EVENT_ID
###########################################################################

--disable_warnings
--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID = '9999';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID > 1 ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID < 1 ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID = @o_tid ;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID = @o_tid and OWNER_EVENT_ID = '9999';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID = @o_tid and OWNER_EVENT_ID < 1;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID = @o_tid and OWNER_EVENT_ID > 1;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID = @o_tid and OWNER_EVENT_ID = @o_eid;

--echo ############# Explain End #########################################
--enable_warnings

flush status;

--replace_column 1 #
select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_THREAD_ID = @o_tid and OWNER_EVENT_ID = @o_eid;

#show session status like "handler_read%";

###########################################################################
# Test index on  OWNER_OBJECT_TYPE, OWNER_OBJECT_SCHEMA, OWNER_OBJECT_NAME
###########################################################################

--disable_warnings
--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_OBJECT_TYPE = "NO_TYPE";

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_OBJECT_TYPE = @o_otype;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_OBJECT_TYPE = @0_0type and
        OWNER_OBJECT_SCHEMA = "impossible";

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_OBJECT_TYPE = @o_otype and
        OWNER_OBJECT_SCHEMA = @o_oschema;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_OBJECT_TYPE = @o_otype and
        OWNER_OBJECT_SCHEMA = @o_oschema and
        OWNER_OBJECT_NAME = "impossible";

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_OBJECT_TYPE = @o_otype and
        OWNER_OBJECT_SCHEMA = @o_oschema and
        OWNER_OBJECT_NAME = @o_oname;

--echo ############# Explain End #########################################
--enable_warnings

flush status;

--replace_column 1 #
select SUM_ERRORS from performance_schema.prepared_statements_instances
  where OWNER_OBJECT_TYPE = @o_otype and
         OWNER_OBJECT_SCHEMA = @o_oschema and
         OWNER_OBJECT_NAME = @o_oname;

#show session status like "handler_read%";

# Cleanup
deallocate prepare st1;
drop procedure proc1;
