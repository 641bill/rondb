# Tests for PERFORMANCE_SCHEMA

--source include/not_embedded.inc
--source include/have_perfschema.inc

create user foo@localhost;
grant ALL on *.* to foo@localhost;

create database explain_test_db;
create table explain_test_db.t1 (c int);
insert into explain_test_db.t1 values ('1');

update performance_schema.setup_consumers set ENABLED='YES' where NAME like "events_stages_%";
update performance_schema.setup_instruments set ENABLED='YES' where NAME like "wait/%";
truncate table performance_schema.events_waits_current;

# Create a new Connection
connect(con1,localhost,foo,,);

--echo # Connection 1
--connection con1

select connection_id() into @conid;

let $tid = `select thread_id from performance_schema.threads
            where PROCESSLIST_ID = @conid`;

select * from explain_test_db.t1;

--echo # Default connection
--connection default

--disable_query_log
--eval select EVENT_ID from performance_schema.events_waits_current where THREAD_ID = $tid limit 1 into @eid;
--eval select $tid into @tid;
--enable_query_log

# Test index on THREAD_ID, EVENT_ID
--disable_warnings

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select THREAD_ID, EVENT_ID
  from performance_schema.events_waits_current
  where THREAD_ID = 1;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select *
  from performance_schema.events_waits_current
  where THREAD_ID > 1;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select *
  from performance_schema.events_waits_current
  where THREAD_ID < 1;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select THREAD_ID, EVENT_ID
  from performance_schema.events_waits_current
  where THREAD_ID = 1 and EVENT_ID = 0;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select THREAD_ID, EVENT_ID
  from performance_schema.events_waits_current
  where THREAD_ID = 99999 and EVENT_ID = @eid;

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select THREAD_ID, EVENT_ID
  from performance_schema.events_waits_current
  where THREAD_ID = @tid and EVENT_ID = @eid;

--enable_warnings
--echo ############# Explain End #########################################

flush status;

--replace_column 1 # 2 #
select EVENT_ID, EVENT_NAME
  from performance_schema.events_waits_current
  where thread_id = @tid and EVENT_ID = @eid limit 1;

let $count1 = query_get_value(show session status like "handler_read_key", Value, 1);

--replace_column 1 # 2 #
select EVENT_ID, EVENT_NAME
  from performance_schema.events_waits_current
  where thread_id = @tid and EVENT_ID = @eid limit 1;

let $count2 = query_get_value(show session status like "handler_read_key", Value, 1);

if ($count1 < $count2)
{
  --echo OK: handler_read_key incremented
}
if ($count1 >= $count2)
{
  --echo ***ERROR*** handler_read_key: Before= $count1, After= $count2
}

drop user foo@localhost;
drop table explain_test_db.t1;
drop database explain_test_db;
