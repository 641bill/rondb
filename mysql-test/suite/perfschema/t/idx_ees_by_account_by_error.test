# Tests for PERFORMANCE_SCHEMA

--source include/not_embedded.inc
--source include/have_perfschema.inc

#setup
create user foo@localhost;
grant ALL on *.* to foo@localhost;
connect(con, localhost, foo,,);

select connection_id() into @conid;
select thread_id from performance_schema.threads
  where PROCESSLIST_ID = @conid
  into @tid;

# Test index on HOST, USER, ERROR_NUMBER

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select HOST, USER, ERROR_NUMBER
  from performance_schema.events_errors_summary_by_account_by_error
  where HOST = 'localhost' and USER= 'foo';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select *
  from performance_schema.events_errors_summary_by_account_by_error
  where HOST != 'localhost' and USER != 'foo';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select HOST, USER, ERROR_NUMBER
  from performance_schema.events_errors_summary_by_account_by_error
  where HOST = 'localhost' and USER= 'foo' and ERROR_NUMBER = '0000';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select HOST, USER, ERROR_NUMBER
  from performance_schema.events_errors_summary_by_account_by_error
  where HOST = 'nohost' and USER= 'nouser' and ERROR_NUMBER = '1146';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select HOST, USER, ERROR_NUMBER
  from performance_schema.events_errors_summary_by_account_by_error
  where HOST = 'localhost' and USER= 'nouser' and ERROR_NUMBER = '1146';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select HOST, USER, ERROR_NUMBER
  from performance_schema.events_errors_summary_by_account_by_error
  where HOST = 'nohost' and USER= 'foo' and ERROR_NUMBER = '1146';

--echo ############ Explain for Query ####################################
--replace_column 10 #
explain select HOST, USER, ERROR_NUMBER
  from performance_schema.events_errors_summary_by_account_by_error
  where HOST = 'localhost' and USER= 'foo' and ERROR_NUMBER = '1146';

--echo ############# Explain End #########################################

flush status;

select ERROR_NUMBER
  from performance_schema.events_errors_summary_by_thread_by_error
  where thread_id = @tid and ERROR_NUMBER = '1146';

let $count1 = query_get_value(show session status like "handler_read_key", Value, 1);

select ERROR_NUMBER
  from performance_schema.events_errors_summary_by_thread_by_error
  where thread_id = @tid and ERROR_NUMBER = '1146';

let $count2 = query_get_value(show session status like "handler_read_key", Value, 1);

if ($count1 < $count2)
{
  --echo OK: handler_read_key incremented
}
if ($count1 >= $count2)
{
  --echo ***ERROR*** handler_read_key: Before= $count1, After= $count2
}

# Cleanup
--connection default
drop user foo@localhost;
