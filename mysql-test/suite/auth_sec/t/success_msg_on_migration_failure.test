--source include/no_valgrind_without_big.inc
--source include/have_innodb_max_16k.inc
--source include/have_openssl.inc
--source include/have_debug.inc

--echo #
--echo # Bug#28330922 - KEYRING MIGRATION FAILS, BUT SAYS "KEYRING MIGRATION
--echo #                SUCCESSFULL" + EMPTY FILE
--echo #

--echo # Restart mysql server with keyring_file plugin
--error 0,1
--remove_files_wildcard $MYSQL_TMP_DIR/dir1 k*
--error 0,1
--remove_files_wildcard $MYSQL_TMP_DIR/dir2 k*
--error 0,1
--rmdir $MYSQL_TMP_DIR/dir1
--error 0,1
--rmdir $MYSQL_TMP_DIR/dir2
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR $KEYRING_PLUGIN_OPT --plugin-dir=KEYRING_PLUGIN_PATH
--replace_regex /\.dll/.so/
--let $restart_parameters=restart:--early-plugin-load="$KEYRING_PLUGIN" --keyring-file-data=$MYSQL_TMP_DIR/dir1/key1 $KEYRING_PLUGIN_OPT
--source include/restart_mysqld.inc

--echo # Generate the key
CREATE DATABASE bug28330922;
USE bug28330922;
CREATE TABLE t1(c1 INT) ENGINE = InnoDB ENCRYPTION="Y";

--echo # Migrate the key
let MIGRATION_SERVER_LOG= $MYSQL_TMP_DIR/migration_server_log;
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR $KEYRING_ENCRYPTED_PLUGIN_OPT --plugin-dir=KEYRING_PLUGIN_OPT
--replace_regex /\.dll/.so/
--error 1
--exec $MYSQLD --no-defaults $KEYRING_ENCRYPTED_PLUGIN_OPT --debug="+d,simulate_keyring_init_error" --keyring-migration-source="$KEYRING_PLUGIN" --keyring_file-data=$MYSQL_TMP_DIR/dir1/key1 --keyring-migration-destination="$KEYRING_ENCRYPTED_PLUGIN" --keyring-encrypted_file-data=$MYSQL_TMP_DIR/dir2/key2 --keyring-encrypted_file-password="ABC" > $MIGRATION_SERVER_LOG 2>&1

let SEARCH_FILE=$MIGRATION_SERVER_LOG;
let SEARCH_PATTERN=\[ERROR\] \[[^]]*\] \[[^]]*\] Plugin 'keyring_file' init function returned error.;
--source include/search_pattern.inc
let SEARCH_PATTERN=\[ERROR\] \[[^]]*\] \[[^]]*\] Keyring migration failed;
--source include/search_pattern.inc
let SEARCH_PATTERN=\[ERROR\] \[[^]]*\] \[[^]]*\] Aborting;
--source include/search_pattern.inc

--echo # Cleanup
DROP DATABASE bug28330922;
--remove_file $MIGRATION_SERVER_LOG
--error 0,1
--remove_files_wildcard $MYSQL_TMP_DIR/dir1 k*
--error 0,1
--remove_files_wildcard $MYSQL_TMP_DIR/dir2 k*
--error 0,1
--rmdir $MYSQL_TMP_DIR/dir1
--error 0,1
--rmdir $MYSQL_TMP_DIR/dir2
