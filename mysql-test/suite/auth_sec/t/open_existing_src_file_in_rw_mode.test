--source include/no_valgrind_without_big.inc
--source include/have_innodb.inc
--source include/not_embedded.inc
--source include/have_innodb_max_16k.inc
--source include/have_openssl.inc

--echo #
--echo # Bug#28339014 - KEYRING MIGRATION FAILS WHEN USER ONLY
--echo #                HAVE READ ACCESS TO THE SOURCE KEYRING
--echo #

--echo # Restart mysql server with keyring_file plugin
--error 0,1
--remove_file $MYSQL_TMP_DIR/dir1/key1
--error 0,1
--remove_file $MYSQL_TMP_DIR/dir1/key2
--error 0,1
--rmdir $MYSQL_TMP_DIR/dir1
--error 0,1
--rmdir $MYSQL_TMP_DIR/dir2
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR $KEYRING_PLUGIN_OPT --plugin-dir=KEYRING_PLUGIN_PATH
--replace_regex /\.dll/.so/
--let $restart_parameters=restart:--early-plugin-load="$KEYRING_PLUGIN" --keyring-file-data=$MYSQL_TMP_DIR/dir1/key1 $KEYRING_PLUGIN_OPT
--source include/restart_mysqld.inc

--echo # Generate the key and make it read only
CREATE DATABASE bug28339014;
USE bug28339014;
CREATE TABLE t1(c1 INT) ENGINE = InnoDB ENCRYPTION="Y";
--chmod 0444 $MYSQL_TMP_DIR/dir1/key1

--echo # Migrate the key
let MIGRATION_SERVER_LOG= $MYSQL_TMP_DIR/migration_server_log;
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR $KEYRING_PLUGIN_OPT --plugin-dir=KEYRING_PLUGIN_PATH
--replace_regex /\.dll/.so/
--exec $MYSQLD --no-defaults --keyring-migration-source="$KEYRING_PLUGIN" --keyring-file-data=$MYSQL_TMP_DIR/dir1/key1 --keyring-migration-destination="$KEYRING_ENCRYPTED_PLUGIN" --keyring-encrypted-file-data=$MYSQL_TMP_DIR/dir2/key2 --keyring-encrypted-file-password="ABC" $KEYRING_PLUGIN_OPT > $MIGRATION_SERVER_LOG 2>&1

--echo # Check the presence of destination keyring file
--file_exists $MYSQL_TMP_DIR/dir2/key2

--echo # Start the server with keyring_encrypted_file and check if the table t1 can be accessed.
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR $KEYRING_ENCRYPTED_PLUGIN_OPT --plugin-dir=KEYRING_ENCRYPTED_PLUGIN_PATH
--replace_regex /\.dll/.so/
--let $restart_parameters=restart:--early-plugin-load="$KEYRING_ENCRYPTED_PLUGIN" --keyring-encrypted-file-data=$MYSQL_TMP_DIR/dir2/key2 --keyring-encrypted-file-password="ABC" $KEYRING_ENCRYPTED_PLUGIN_OPT
--source include/restart_mysqld.inc
USE bug28339014;
SELECT * FROM t1;

--echo # Cleanup
DROP DATABASE bug28339014;
--remove_file $MIGRATION_SERVER_LOG
--error 0,1
--remove_file $MYSQL_TMP_DIR/dir1/key1
--error 0,1
--remove_file $MYSQL_TMP_DIR/dir2/key2
--error 0,1
--rmdir $MYSQL_TMP_DIR/dir1
--error 0,1
--rmdir $MYSQL_TMP_DIR/dir2
