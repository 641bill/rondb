CREATE USER foo;
CREATE DATABASE `db_1`;
CREATE DATABASE `db%1`;
#-----------------------------------------------------------------------
# Case: Try to turn --partial_revokes ON when db grant with wildcard exists
GRANT SELECT ON db_1.* TO foo;
SET @@global.partial_revokes=ON;
ERROR HY000: Can not set --partial_revokes to ON at runtime if database grants with wildcard characters exists. Please remove such grants first.
REVOKE SELECT ON db_1.* FROM foo;
GRANT SELECT ON `db%1`.* TO foo;
SET @@global.partial_revokes=ON;
ERROR HY000: Can not set --partial_revokes to ON at runtime if database grants with wildcard characters exists. Please remove such grants first.
REVOKE SELECT ON `db%1`.* FROM foo;
FLUSH PRIVILEGES;
#-----------------------------------------------------------------------
# Case: Try to create db grant with wildcard when --partial_revokes is ON
SET @@global.partial_revokes=ON;
GRANT SELECT ON db_1.* TO foo;
ERROR HY000: Use of wildcards in database grant is not permitted because --partial_revokes is set to ON.
GRANT SELECT ON `db%1`.* TO foo;
ERROR HY000: Use of wildcards in database grant is not permitted because --partial_revokes is set to ON.
GRANT SELECT ON `db\_1`.* TO foo;
GRANT SELECT ON `db\%1`.* TO foo;
REVOKE SELECT ON `db\_1`.* FROM  foo;
REVOKE SELECT ON `db\%1`.* FROM  foo;
FLUSH PRIVILEGES;
SET @@global.partial_revokes=OFF;
#-----------------------------------------------------------------------
# Case: DB grants with wildcards should be ignored if --partial_revokes
#       is ON at startup/FLUSH PRIVILEGES
INSERT INTO mysql.db(user, host, db, Insert_priv) VALUES('foo', '%', 'db_1', 'Y');
INSERT INTO mysql.db(user, host, db, Insert_priv) VALUES('foo', '%', 'db%1', 'Y');
SET @@global.partial_revokes=ON;
FLUSH PRIVILEGES;
# Search for : Ignored database grant with wildcard characters 'db_1' for user 'foo'@'%' because --partial_revokes is set to ON
Pattern "Ignored database grant with wildcard characters 'db_1' for user 'foo'@'%' because --partial_revokes is set to ON" found
# Search for : Ignored database grant with wildcard characters 'db%1' for user 'foo'@'%' because --partial_revokes is set to ON
Pattern "Ignored database grant with wildcard characters 'db%1' for user 'foo'@'%' because --partial_revokes is set to ON" found
# Search completed.
SHOW GRANTS FOR foo;
Grants for foo@%
GRANT USAGE ON *.* TO `foo`@`%`
DELETE FROM mysql.db WHERE user = 'foo';
FLUSH PRIVILEGES;
SET @@global.partial_revokes=OFF;
#-----------------------------------------------------------------------
# Case: Partial revokes and nonwildcard db grants with _ and %
SET @@global.partial_revokes=ON;
GRANT SELECT ON *.* TO foo;
REVOKE SELECT ON `db_1`.* FROM foo;
REVOKE SELECT ON `db%1`.* FROM foo;
SHOW GRANTS FOR foo;
Grants for foo@%
GRANT SELECT ON *.* TO `foo`@`%`
REVOKE SELECT ON `db%1`.* FROM `foo`@`%`
REVOKE SELECT ON `db_1`.* FROM `foo`@`%`
GRANT SELECT ON `db\_1`.* TO foo;
SHOW GRANTS FOR foo;
Grants for foo@%
GRANT SELECT ON *.* TO `foo`@`%`
REVOKE SELECT ON `db%1`.* FROM `foo`@`%`
GRANT SELECT ON `db\%1`.* TO foo;
SHOW GRANTS FOR foo;
Grants for foo@%
GRANT SELECT ON *.* TO `foo`@`%`
REVOKE SELECT ON *.* FROM foo;
SET @@global.partial_revokes=OFF;
SET @@global.partial_revokes=ON;
GRANT SELECT ON *.* TO foo;
GRANT SELECT ON `db\_1`.* TO foo;
GRANT SELECT ON `db\%1`.* TO foo;
SHOW GRANTS FOR foo;
Grants for foo@%
GRANT SELECT ON *.* TO `foo`@`%`
GRANT SELECT ON `db\%1`.* TO `foo`@`%`
GRANT SELECT ON `db\_1`.* TO `foo`@`%`
REVOKE SELECT ON `db_1`.* FROM foo;
REVOKE SELECT ON `db%1`.* FROM foo;
SHOW GRANTS FOR foo;
Grants for foo@%
GRANT SELECT ON *.* TO `foo`@`%`
REVOKE SELECT ON *.* FROM foo;
SET @@global.partial_revokes=OFF;
#-----------------------------------------------------------------------
# Cleanup
DROP DATABASE `db%1`;
DROP DATABASE `db_1`;
DROP USER foo;
#-----------------------------------------------------------------------
