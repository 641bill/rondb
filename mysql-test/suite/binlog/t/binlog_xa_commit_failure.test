################################################################################
# BUG#25978684: GR+XA: ASSERT `! IS_SET() AT SQL_ERROR.CC:406 WHEN MEMBER IS IN ERROR/RECOVERING
# Validate that XA COMMIT does handle a local failure properly.
#
# Test:
# 1. Prepare the data for the test.
# 2. Execute a XA PREPARE with id '1'.
# 3. Force a local failure in before_commit listener on the
#    XA COMMIT.
# 4. Clean up.
################################################################################
--source include/have_debug.inc
--source include/have_binlog_format_row.inc


--echo
--echo ############################################################
--echo # 1. Prepare the data for the test.
CREATE TABLE t1 (c1 INT PRIMARY KEY);


--echo
--echo ############################################################
--echo # 2. Execute a XA PREPARE with id '1'.
--connect (server1_conn2, 127.0.0.1, root, , test, $MASTER_MYPORT,)
XA START 'xid1';
INSERT INTO t1 VALUES (1);
XA END 'xid1';
XA PREPARE 'xid1';
--disconnect server1_conn2


--echo
--echo ############################################################
--echo # 3. Force a local failure in before_commit listener on the
--echo #    XA COMMIT.
--connection default
SET @debug_save= @@GLOBAL.DEBUG;
SET @@GLOBAL.DEBUG= '+d,simulate_failure_in_before_commit_hook';

--error ER_RUN_HOOK_ERROR
XA COMMIT 'xid1';
SHOW ERRORS;
SET @@GLOBAL.DEBUG= @debug_save;


--echo
--echo ############################################################
--echo # 4. Clean up.
DROP TABLE t1;
