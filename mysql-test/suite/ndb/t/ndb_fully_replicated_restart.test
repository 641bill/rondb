--source include/have_ndb.inc
--source include/not_windows.inc

CREATE TABLE t1 (
  a int,
  b varchar(255),
  c int,
  primary key(a,b),
  key(b),
  unique (c)) engine=ndb comment='NDB_TABLE=ALLNODES' partition by key(a) ;

CREATE TABLE t2 (
  a int,
  b varchar(255),
  c int,
  primary key(a,b),
  key(b),
  unique (c)) engine=ndb comment='NDB_TABLE=FULLY_REPLICATED=1' partition by key(a) ;

--let ndb_desc_opts= -d test t1
--source suite/ndb/include/ndb_desc_print.inc

insert into t1 values
(0, "row 0", 0),(1, "row 1", 1),
(2, "row 2", 2),(3, "row 3", 3),
(4, "row 4", 4),(5, "row 5", 5),
(6, "row 6", 6),(7, "row 7", 7),
(8, "row 8", 8),(9, "row 9", 9);

select * from t1 order by 1;

begin;
# pk lookup
select * from t1 where a = 7;
# uk lookup
select * from t1 where c = 9;
# table scan
select * from t1 order by 1;
# index scan
select * from t1 where a < 5 order by a;
# pk update
update t1 set b = 'pk update' where a = 3;
# scan update
update t1 set c = c + 10;
# uk update
update t1 set b = 'uk update' where c = 16;
# pk delete
delete from t1 where a = 7;
# uk delete
delete from t1 where c = 17;
# index scan delete
delete from t1 where a < 5;
select * from t1 order by 1;
insert into t1 values (0, "row 0", 0),(1, "row 1", 1);
select * from t1 order by 1;
rollback;

--echo "Stop node 1"

# Restart 1 node "nostart"
--exec $NDB_MGM --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" -e "1 restart -n" >> $NDB_TOOLS_OUTPUT
# Wait for node to enter "nostart"
--exec $NDB_WAITER --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" --not-started --wait-nodes=1 >> $NDB_TOOLS_OUTPUT

begin;
# pk lookup
select * from t1 where a = 7;
# uk lookup
select * from t1 where c = 9;
# table scan
select * from t1 order by 1;
# index scan
select * from t1 where a < 5 order by a;
# pk update
update t1 set b = 'pk update' where a = 3;
# scan update
update t1 set c = c + 10;
# uk update
update t1 set b = 'uk update' where c = 16;
# pk delete
delete from t1 where a = 7;
# uk delete
delete from t1 where c = 17;
# index scan delete
delete from t1 where a < 5;
select * from t1 order by 1;
insert into t1 values (0, "row 0", 0),(1, "row 1", 1);
select * from t1 order by 1;
rollback;

--echo "Start node 1"

# Start node again
--exec $NDB_MGM --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" -e "1 start" >> $NDB_TOOLS_OUTPUT
# Wait for all nodes to enter "started"
--exec $NDB_WAITER --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" >> $NDB_TOOLS_OUTPUT

begin;
# pk lookup
select * from t1 where a = 7;
# uk lookup
select * from t1 where c = 9;
# table scan
select * from t1 order by 1;
# index scan
select * from t1 where a < 5 order by a;
# pk update
update t1 set b = 'pk update' where a = 3;
# scan update
update t1 set c = c + 10;
# uk update
update t1 set b = 'uk update' where c = 16;
# pk delete
delete from t1 where a = 7;
# uk delete
delete from t1 where c = 17;
# index scan delete
delete from t1 where a < 5;
select * from t1 order by 1;
insert into t1 values (0, "row 0", 0),(1, "row 1", 1);
select * from t1 order by 1;
rollback;

drop table t1, t2;
CREATE TABLE t1 (
  a int,
  b varchar(255),
  c int,
  primary key(a,b),
  key(b),
  unique (c)) engine=ndb comment='NDB_TABLE=ALLNODES' partition by key(a) ;
CREATE TABLE t2 (
  a int,
  b varchar(255),
  c int,
  primary key(a,b),
  key(b),
  unique (c)) engine=ndb comment='NDB_TABLE=FULLY_REPLICATED=1' partition by key(a) ;
insert into t1 values
(0, "row 0", 0),(1, "row 1", 1),
(2, "row 2", 2),(3, "row 3", 3),
(4, "row 4", 4),(5, "row 5", 5),
(6, "row 6", 6),(7, "row 7", 7),
(8, "row 8", 8),(9, "row 9", 9);

--echo "Restart cluster"

# Restart cluster nodes "nostart"
--exec $NDB_MGM --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" -e "all restart -n" >> $NDB_TOOLS_OUTPUT
# Wait for all nodes to enter "nostart"
--exec $NDB_WAITER --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" --not-started >> $NDB_TOOLS_OUTPUT
# Start cluster nodes again
--exec $NDB_MGM --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" -e "all start" >> $NDB_TOOLS_OUTPUT
# Wait for all nodes to enter "started"
--exec $NDB_WAITER --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING" >> $NDB_TOOLS_OUTPUT

#
# Wait until the connection to the
# cluster has been restored or timeout occurs
#
--echo "Wait reconnect"
--disable_result_log
--disable_query_log
--source include/ndb_not_readonly.inc
--enable_result_log
--enable_query_log

begin;
# pk lookup
select * from t1 where a = 7;
# uk lookup
select * from t1 where c = 9;
# table scan
select * from t1 order by 1;
# index scan
select * from t1 where a < 5 order by a;
# pk update
update t1 set b = 'pk update' where a = 3;
# scan update
update t1 set c = c + 10;
# uk update
update t1 set b = 'uk update' where c = 16;
# pk delete
delete from t1 where a = 7;
# uk delete
delete from t1 where c = 17;
# index scan delete
delete from t1 where a < 5;
select * from t1 order by 1;
insert into t1 values (0, "row 0", 0),(1, "row 1", 1);
select * from t1 order by 1;
rollback;

# cleanup
drop table t1, t2;
