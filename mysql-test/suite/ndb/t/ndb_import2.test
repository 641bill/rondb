--source include/have_ndb.inc
--source include/not_windows.inc
--source suite/ndb/include/ndb_find_import_tool.inc
--source have_ndb_error_insert.inc

--echo # large ndb_import tests

--echo # temporary error test

perl;
use strict;
use Symbol;
my $vardir = $ENV{MYSQLTEST_VARDIR}
  or die "need MYSQLTEST_VARDIR";
my $file = "$vardir/tmp/t1.csv";
my $fh = gensym();
open($fh, ">$file")
  or die "$file: open for write failed: $!";
for (my $i = 0; $i < 1000000; $i++) {
  print $fh $i, "\t", int(rand(1000)), "\n";
}
close($fh)
  or "$file: close after write failed: $!";
exit(0);
EOF

create table t1 (
  a int not null,
  b int not null,
  primary key using hash (a)
) engine ndb;

create table t1ver like t1;

show create table t1;
show create table t1ver;

# crash node 2 in 5-15 seconds

exec $NDB_MGM --no-defaults --ndb-connectstring="$NDB_CONNECTSTRING"
     -e "2 dump 9999 5000 15000" >> NDB_TOOLS_OUTPUT 2>&1;

exec $NDB_IMPORT --state-dir=$MYSQLTEST_VARDIR/tmp
     --temperrors=1000
     test $MYSQLTEST_VARDIR/tmp/t1.csv >> $NDB_TOOLS_OUTPUT 2>&1;

select count(*) from t1;

--disable_query_log
eval load data infile '$MYSQLTEST_VARDIR/tmp/t1.csv'
into table t1ver;
--enable_query_log

select count(*) from t1 x, t1ver y
where x.a = y.a and x.b = y.b;

drop table t1, t1ver;
