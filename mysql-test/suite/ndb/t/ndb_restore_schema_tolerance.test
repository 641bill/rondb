######################################################################
# Test restoring backups into similar schemas
######################################################################

-- source include/have_ndb.inc
-- source include/ndb_default_cluster.inc

--echo Test ndb_restore ability to ignore some schema differences

use test;
create table t1 (
  a int,
  b int,
  c int,
  d int,
  e varchar(200),
  f int,
  g char(20),
  h text,
  i int,
  primary key(a,b)) TABLESPACE ts1 engine = ndb;

insert into t1 values
        (1, 1, 1, 1, '1', 1, 'Rankin', 'Rebus', 1),
        (2, 2, 2, 2, '2', 2, 'Doyle', 'Holmes', 2),
        (3, 3, 3, 3, '3', 3, 'Burns', 'Mouse', 3),
        (4, 4, 4, 4, '4', 4, 'Gibbon', 'Chris', 4),
        (5, 5, 5, 5, '5', 5, 'Gray', 'Lanark', 5);

select * from t1 order by a;

--echo Backing up data
--source include/ndb_backup.inc

drop table t1;

--echo Normal restore
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r -m  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 2 -r     $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

show create table t1;

select * from t1 order by a;

truncate t1;

--echo Column name change, should fail without --exclude-missing-columns

alter table t1 change c cc int;

--error 1
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

--echo Retry with --exclude-missing-columns

--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r --exclude-missing-columns $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 2 -r --exclude-missing-columns $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

select * from t1 order by a;
truncate t1;

--echo Column type change, should fail

alter table t1 change cc c bigint;
show create table t1; #REMOVE!
--error 1
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

--echo Retry with --promote-attribute

--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r --promote-attribute $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 2 -r --promote-attribute $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

select * from t1 order by a;
truncate t1;

--echo Column nullability change, should fail

alter table t1 change c c int not null;

--error 1
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

alter table t1 change c c int;

# Skip Precision and scale differences - should fail

--echo Column length change, should fail

alter table t1 change g g char(22);

--error 1
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

--echo Character set difference, should fail

alter table t1 change g g char(20) character set binary;

--error 1
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

alter table t1 change g g char(20);

--echo AutoIncrement difference, should fail

alter table t1 change b b int auto_increment;

--error 1
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

--echo Default difference, should pass 
alter table t1 change b b int default 22;

--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 2 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

select * from t1 order by a;
truncate t1;

alter table t1 change b b int;

--echo ArrayType difference, should fail
alter table t1 change e e varchar(300);

--error 1
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

alter table t1 change e e varchar(200);

--echo StorageType difference, should pass
CREATE LOGFILE GROUP lg1
ADD UNDOFILE 'undofile.dat'
INITIAL_SIZE 16M
UNDO_BUFFER_SIZE = 1M
ENGINE=NDB;

CREATE TABLESPACE ts1
ADD DATAFILE 'datafile.dat'
USE LOGFILE GROUP lg1
INITIAL_SIZE 12M
ENGINE NDB;

alter table t1 change i i int storage disk;

--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 2 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

select * from t1 order by a;

alter table t1 change i i int storage memory;
truncate t1;

# Skip BlobType difference (should fail)

--echo Dynamic property difference, should pass

alter table t1 change c c int column_format dynamic;

--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 2 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

select * from t1 order by a;

drop table t1;
alter tablespace ts1 drop datafile 'datafile.dat' engine=ndb;
drop tablespace ts1 engine=ndb;
drop logfile group lg1 engine=ndb;

--echo Different PK columns, should fail
create table t1 (
  a int,
  b int,
  c int,
  d int,
  e varchar(200),
  f int,
  g char(20),
  h text,
  i int,
  primary key (a)) TABLESPACE ts1 engine = ndb;

--error 1
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

drop table t1;

--echo Different distribution keys, should pass

create table t1 (
  a int,
  b int,
  c int,
  d int,
  e varchar(200),
  f int,
  g char(20),
  h text,
  i int,
  primary key(a,b)) TABLESPACE ts1 engine = ndb partition by key(a);

--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT
--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 2 -r  $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

select * from t1 order by a;

drop table t1;

--echo Restore table with largest possible descriptor

CREATE TABLE GRP_HssEsmUsersStoredByTenant(T1 bigint PRIMARY KEY,
T2 bigint unique default 65535,
T3 bigint unique default 65535,
T4 bigint unique default 65535,
T5 bigint unique default 65535,
T6 bigint unique default 65535,
T7 bigint unique default 65535,
T8 bigint unique default 65535,
T9 bigint unique default 65535,
T10 bigint unique default 65535,
T11 bigint unique default 65535,
T12 bigint unique default 65535,
T13 bigint unique default 65535,
T14 bigint unique default 65535,
T15 bigint unique default 65535,
T16 bigint unique default 65535,
T17 bigint unique default 65535,
T18 bigint unique default 65535,
T19 bigint unique default 65535,
T20 bigint unique default 65535,
T21 bigint unique default 65535,
T22 bigint unique default 65535,
T23 bigint unique default 65535,
T24 bigint unique default 65535,
T25 bigint unique default 65535,
T26 bigint unique default 65535,
T27 bigint unique default 65535,
T28 bigint unique default 65535,
T29 bigint unique default 65535,
T30 bigint unique default 65535,
T31 bigint unique default 65535,
T32 bigint unique default 65535,
T33 bigint unique default 65535,
T34 bigint unique default 65535,
T35 bigint unique default 65535,
T36 bigint unique default 65535,
T37 bigint unique default 65535,
T38 bigint unique default 65535,
T39 bigint unique default 65535,
T40 bigint unique default 65535,
T41 bigint unique default 65535,
T42 bigint unique default 65535,
T43 bigint unique default 65535,
T44 bigint unique default 65535,
T45 bigint unique default 65535,
T46 bigint unique default 65535,
T47 bigint unique default 65535,
T48 bigint unique default 65535,
T49 bigint unique default 65535,
T50 bigint unique default 65535,
T51 bigint unique default 65535,
T52 bigint unique default 65535,
T53 bigint unique default 65535,
T54 bigint unique default 65535,
T55 bigint unique default 65535,
T56 bigint unique default 65535,
T57 bigint unique default 65535,
T58 bigint unique default 65535,
T59 bigint unique default 65535,
T60 bigint unique default 65535,
T61 bigint unique default 65535,
T62 bigint unique default 65535,
T63 bigint unique default 65535,
T64 bigint unique default 65535,
T65 bigint default 65535,
T66 bigint default 65535,
T67 bigint default 65535,
T68 bigint default 65535,
T69 bigint default 65535,
T70 bigint default 65535,
T71 bigint default 65535,
T72 bigint default 65535,
T73 bigint default 65535,
T74 bigint default 65535,
T75 bigint default 65535,
T76 bigint default 65535,
T77 bigint default 65535,
T78 bigint default 65535,
T79 bigint default 65535,
T80 bigint default 65535,
T81 bigint default 65535,
T82 bigint default 65535,
T83 bigint default 65535,
T84 bigint default 65535,
T85 bigint default 65535,
T86 bigint default 65535,
T87 bigint default 65535,
T88 bigint default 65535,
T89 bigint default 65535,
T90 bigint default 65535,
T91 bigint default 65535,
T92 bigint default 65535,
T93 bigint default 65535,
T94 bigint default 65535,
T95 bigint default 65535,
T96 bigint default 65535,
T97 bigint default 65535,
T98 bigint default 65535,
T99 bigint default 65535,
T100 bigint default 65535,
T101 bigint default 65535,
T102 bigint default 65535,
T103 bigint default 65535,
T104 bigint default 65535,
T105 bigint default 65535,
T106 bigint default 65535,
T107 bigint default 65535,
T108 bigint default 65535,
T109 bigint default 65535,
T110 bigint default 65535,
T111 bigint default 65535,
T112 bigint default 65535,
T113 bigint default 65535,
T114 bigint default 65535,
T115 bigint default 65535,
T116 bigint default 65535,
T117 bigint default 65535,
T118 bigint default 65535,
T119 bigint default 65535,
T120 bigint default 65535,
T121 bigint default 65535,
T122 bigint default 65535,
T123 bigint default 65535,
T124 bigint default 65535,
T125 bigint default 65535,
T126 bigint default 65535,
T127 bigint default 65535,
T128 bigint default 65535,
T129 bigint default 65535,
T130 bigint default 65535,
T131 bigint default 65535,
T132 bigint default 65535,
T133 bigint default 65535,
T134 bigint default 65535,
T135 bigint default 65535,
T136 bigint default 65535,
T137 bigint default 65535,
T138 bigint default 65535,
T139 bigint default 65535,
T140 bigint default 65535,
T141 bigint default 65535,
T142 bigint default 65535,
T143 bigint default 65535,
T144 bigint default 65535,
T145 bigint default 65535,
T146 bigint default 65535,
T147 bigint default 65535,
T148 bigint default 65535,
T149 bigint default 65535,
T150 bigint default 65535,
T151 bigint default 65535,
T152 bigint default 65535,
T153 bigint default 65535,
T154 bigint default 65535,
T155 bigint default 65535,
T156 bigint default 65535,
T157 bigint default 65535,
T158 bigint default 65535,
T159 bigint default 65535,
T160 bigint default 65535,
T161 bigint default 65535,
T162 bigint default 65535,
T163 bigint default 65535,
T164 bigint default 65535,
T165 bigint default 65535,
T166 bigint default 65535,
T167 bigint default 65535,
T168 bigint default 65535,
T169 bigint default 65535,
T170 bigint default 65535,
T171 bigint default 65535,
T172 bigint default 65535,
T173 bigint default 65535,
T174 bigint default 65535,
T175 bigint default 65535,
T176 bigint default 65535,
T177 bigint default 65535,
T178 bigint default 65535,
T179 bigint default 65535,
T180 bigint default 65535,
T181 bigint default 65535,
T182 bigint default 65535,
T183 bigint default 65535,
T184 bigint default 65535,
T185 bigint default 65535,
T186 bigint default 65535,
T187 bigint default 65535,
T188 bigint default 65535,
T189 bigint default 65535,
T190 bigint default 65535,
T191 bigint default 65535,
T192 bigint default 65535,
T193 bigint default 65535,
T194 bigint default 65535,
T195 bigint default 65535,
T196 bigint default 65535,
T197 bigint default 65535,
T198 bigint default 65535,
T199 bigint default 65535,
T200 bigint default 65535,
T201 bigint default 65535,
T202 bigint default 65535,
T203 bigint default 65535,
T204 bigint default 65535,
T205 bigint default 65535,
T206 bigint default 65535,
T207 bigint default 65535,
T208 bigint default 65535,
T209 bigint default 65535,
T210 bigint default 65535,
T211 bigint default 65535,
T212 bigint default 65535,
T213 bigint default 65535,
T214 bigint default 65535,
T215 bigint default 65535,
T216 bigint default 65535,
T217 bigint default 65535,
T218 bigint default 65535,
T219 bigint default 65535,
T220 bigint default 65535,
T221 bigint default 65535,
T222 bigint default 65535,
T223 bigint default 65535,
T224 bigint default 65535,
T225 bigint default 65535,
T226 bigint default 65535,
T227 bigint default 65535,
T228 bigint default 65535,
T229 bigint default 65535,
T230 bigint default 65535,
T231 bigint default 65535,
T232 bigint default 65535,
T233 bigint default 65535,
T234 bigint default 65535,
T235 bigint default 65535,
T236 bigint default 65535,
T237 bigint default 65535,
T238 bigint default 65535,
T239 bigint default 65535,
T240 bigint default 65535,
T241 bigint default 65535,
T242 bigint default 65535,
T243 bigint default 65535,
T244 bigint default 65535,
T245 bigint default 65535,
T246 bigint default 65535,
T247 bigint default 65535,
T248 bigint default 65535,
T249 bigint default 65535,
T250 bigint default 65535,
T251 bigint default 65535,
T252 bigint default 65535,
T253 bigint default 65535,
T254 bigint default 65535,
T255 bigint default 65535,
T256 bigint default 65535,
T257 bigint default 65535,
T258 bigint default 65535,
T259 bigint default 65535,
T260 bigint default 65535,
T261 bigint default 65535,
T262 bigint default 65535,
T263 bigint default 65535,
T264 bigint default 65535,
T265 bigint default 65535,
T266 bigint default 65535,
T267 bigint default 65535,
T268 bigint default 65535,
T269 bigint default 65535,
T270 bigint default 65535,
T271 bigint default 65535,
T272 bigint default 65535,
T273 bigint default 65535,
T274 bigint default 65535,
T275 bigint default 65535,
T276 bigint default 65535,
T277 bigint default 65535,
T278 bigint default 65535,
T279 bigint default 65535,
T280 bigint default 65535,
T281 bigint default 65535,
T282 bigint default 65535,
T283 bigint default 65535,
T284 bigint default 65535,
T285 bigint default 65535,
T286 bigint default 65535,
T287 bigint default 65535,
T288 bigint default 65535,
T289 bigint default 65535,
T290 bigint default 65535,
T291 bigint default 65535,
T292 bigint default 65535,
T293 bigint default 65535,
T294 bigint default 65535,
T295 bigint default 65535,
T296 bigint default 65535,
T297 bigint default 65535,
T298 bigint default 65535,
T299 bigint default 65535,
T300 bigint default 65535,
T301 bigint default 65535,
T302 bigint default 65535,
T303 bigint default 65535,
T304 bigint default 65535,
T305 bigint default 65535,
T306 bigint default 65535,
T307 bigint default 65535,
T308 bigint default 65535,
T309 bigint default 65535,
T310 bigint default 65535,
T311 bigint default 65535,
T312 bigint default 65535,
T313 bigint default 65535,
T314 bigint default 65535,
T315 bigint default 65535,
T316 bigint default 65535,
T317 bigint default 65535,
T318 bigint default 65535,
T319 bigint default 65535,
T320 bigint default 65535,
T321 bigint default 65535,
T322 bigint default 65535,
T323 bigint default 65535,
T324 bigint default 65535,
T325 bigint default 65535,
T326 bigint default 65535,
T327 bigint default 65535,
T328 bigint default 65535,
T329 bigint default 65535,
T330 bigint default 65535,
T331 bigint default 65535,
T332 bigint default 65535,
T333 bigint default 65535,
T334 bigint default 65535,
T335 bigint default 65535,
T336 bigint default 65535,
T337 bigint default 65535,
T338 bigint default 65535,
T339 bigint default 65535,
T340 bigint default 65535,
T341 bigint default 65535,
T342 bigint default 65535,
T343 bigint default 65535,
T344 bigint default 65535,
T345 bigint default 65535,
T346 bigint default 65535,
T347 bigint default 65535,
T348 bigint default 65535,
T349 bigint default 65535,
T350 bigint default 65535,
T351 bigint default 65535,
T352 bigint default 65535,
T353 bigint default 65535,
T354 bigint default 65535,
T355 bigint default 65535,
T356 bigint default 65535,
T357 bigint default 65535,
T358 bigint default 65535,
T359 bigint default 65535,
T360 bigint default 65535,
T361 bigint default 65535,
T362 bigint default 65535,
T363 bigint default 65535,
T364 bigint default 65535,
T365 bigint default 65535,
T366 bigint default 65535,
T367 bigint default 65535,
T368 bigint default 65535,
T369 bigint default 65535,
T370 bigint default 65535,
T371 bigint default 65535,
T372 bigint default 65535,
T373 bigint default 65535,
T374 bigint default 65535,
T375 bigint default 65535,
T376 bigint default 65535,
T377 bigint default 65535,
T378 bigint default 65535,
T379 bigint default 65535,
T380 bigint default 65535,
T381 bigint default 65535,
T382 bigint default 65535,
T383 bigint default 65535,
T384 bigint default 65535,
T385 bigint default 65535,
T386 bigint default 65535,
T387 bigint default 65535,
T388 bigint default 65535,
T389 bigint default 65535,
T390 bigint default 65535,
T391 bigint default 65535,
T392 bigint default 65535,
T393 bigint default 65535,
T394 bigint default 65535,
T395 bigint default 65535,
T396 bigint default 65535,
T397 bigint default 65535,
T398 bigint default 65535,
T399 bigint default 65535,
T400 bigint default 65535,
T401 bigint default 65535,
T402 bigint default 65535,
T403 bigint default 65535,
T404 bigint default 65535,
T405 bigint default 65535,
T406 bigint default 65535,
T407 bigint default 65535,
T408 bigint default 65535,
T409 bigint default 65535,
T410 bigint default 65535,
T411 bigint default 65535,
T412 bigint default 65535,
T413 bigint default 65535,
T414 bigint default 65535,
T415 bigint default 65535,
T416 bigint default 65535,
T417 bigint default 65535,
T418 bigint default 65535,
T419 bigint default 65535,
T420 bigint default 65535,
T421 bigint default 65535,
T422 bigint default 65535,
T423 bigint default 65535,
T424 bigint default 65535,
T425 bigint default 65535,
T426 bigint default 65535,
T427 bigint default 65535,
T428 bigint default 65535,
T429 bigint default 65535,
T430 bigint default 65535,
T431 bigint default 65535,
T432 bigint default 65535,
T433 bigint default 65535,
T434 bigint default 65535,
T435 bigint default 65535,
T436 bigint default 65535,
T437 bigint default 65535,
T438 bigint default 65535,
T439 bigint default 65535,
T440 bigint default 65535,
T441 bigint default 65535,
T442 bigint default 65535,
T443 bigint default 65535,
T444 bigint default 65535,
T445 bigint default 65535,
T446 bigint default 65535,
T447 bigint default 65535,
T448 bigint default 65535,
T449 bigint default 65535,
T450 bigint default 65535,
T451 bigint default 65535,
T452 bigint default 65535,
T453 bigint default 65535,
T454 bigint default 65535,
T455 bigint default 65535,
T456 bigint default 65535,
T457 bigint default 65535,
T458 bigint default 65535,
T459 bigint default 65535,
T460 bigint default 65535,
T461 bigint default 65535,
T462 bigint default 65535,
T463 bigint default 65535,
T464 bigint default 65535,
T465 bigint default 65535,
T466 bigint default 65535,
T467 bigint default 65535,
T468 bigint default 65535,
T469 bigint default 65535,
T470 bigint default 65535,
T471 bigint default 65535,
T472 bigint default 65535,
T473 bigint default 65535,
T474 bigint default 65535,
T475 bigint default 65535,
T476 bigint default 65535,
T477 bigint default 65535,
T478 bigint default 65535,
T479 bigint default 65535,
T480 bigint default 65535,
T481 bigint default 65535,
T482 bigint default 65535,
T483 bigint default 65535,
T484 bigint default 65535,
T485 bigint default 65535,
T486 bigint default 65535,
T487 bigint default 65535,
T488 bigint default 65535,
T489 bigint default 65535,
T490 bigint default 65535,
T491 bigint default 65535,
T492 bigint default 65535,
T493 bigint default 65535,
T494 bigint default 65535,
T495 bigint default 65535,
T496 bigint default 65535,
T497 bigint default 65535,
T498 bigint default 65535,
T499 bigint default 65535,
T500 bigint default 65535,
T501 bigint default 65535,
T502 bigint default 65535,
T503 bigint default 65535,
T504 bigint default 65535,
T505 bigint default 65535,
T506 bigint default 65535,
T507 bigint default 65535,
T508 bigint default 65535,
T509 bigint default 65535,
T510 bigint default 65535,
T511 bigint default 65535,
T512 bigint default 65535
) engine=ndb;

--echo Backing up data
--source include/ndb_backup.inc
drop table GRP_HssEsmUsersStoredByTenant;

--exec $NDB_RESTORE --no-defaults --core-file=false -b $the_backup_id -n 1 -m  --print-log $NDB_BACKUP_DIR/BACKUP/BACKUP-$the_backup_id >> $NDB_TOOLS_OUTPUT

drop table GRP_HssEsmUsersStoredByTenant;
