SET @@session.default_storage_engine = 'MyISAM';
# RAND()
create table t1 (b virtual double as (rand()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# LOAD_FILE()
create table t1 (a varchar(64), b virtual varchar(1024) as (load_file(a)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# CURDATE()
create table t1 (a virtual datetime as (curdate()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# CURRENT_DATE(), CURRENT_DATE
create table t1 (a virtual datetime as (current_date));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
create table t1 (a virtual datetime as (current_date()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# CURRENT_TIME(), CURRENT_TIME
create table t1 (a virtual datetime as (current_time));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
create table t1 (a virtual datetime as (current_time()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# CURRENT_TIMESTAMP(), CURRENT_TIMESTAMP
create table t1 (a virtual datetime as (current_timestamp()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
create table t1 (a virtual datetime as (current_timestamp));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# CURTIME()
create table t1 (a virtual datetime as (curtime()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# LOCALTIME(), LOCALTIME
create table t1 (a datetime, b virtual varchar(10) as (localtime()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
create table t1 (a datetime, b virtual varchar(10) as (localtime));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# LOCALTIMESTAMP, LOCALTIMESTAMP()(v4.0.6)
create table t1 (a datetime, b virtual varchar(10) as (localtimestamp()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
create table t1 (a datetime, b virtual varchar(10) as (localtimestamp));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# NOW()
create table t1 (a datetime, b virtual varchar(10) as (now()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# SYSDATE()
create table t1 (a int, b virtual varchar(10) as (sysdate()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# UNIX_TIMESTAMP()
create table t1 (a datetime, b virtual datetime as (unix_timestamp()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# UTC_DATE()
create table t1 (a datetime, b virtual datetime as (utc_date()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# UTC_TIME()
create table t1 (a datetime, b virtual datetime as (utc_time()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# UTC_TIMESTAMP()
create table t1 (a datetime, b virtual datetime as (utc_timestamp()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# MATCH()
create table t1 (a varchar(32), b virtual bool as (match a against ('sample text')));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# BENCHMARK()
create table t1 (a varchar(1024), b virtual varchar(1024) as (benchmark(a,3)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# CONNECTION_ID()
create table t1 (a virtual int as (connection_id()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# CURRENT_USER(), CURRENT_USER
create table t1 (a virtual varchar(32) as (current_user()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
create table t1 (a virtual varchar(32) as (current_user));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# DATABASE()
create table t1 (a varchar(1024), b virtual varchar(1024) as (database()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# FOUND_ROWS()
create table t1 (a varchar(1024), b virtual varchar(1024) as (found_rows()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# GET_LOCK()
create table t1 (a varchar(1024), b virtual varchar(1024) as (get_lock(a,10)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# IS_FREE_LOCK()
create table t1 (a varchar(1024), b virtual varchar(1024) as (is_free_lock(a)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# IS_USED_LOCK()
create table t1 (a varchar(1024), b virtual varchar(1024) as (is_used_lock(a)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# LAST_INSERT_ID()
create table t1 (a virtual int as (last_insert_id()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# MASTER_POS_WAIT()
create table t1 (a varchar(32), b virtual int as (master_pos_wait(a,0,2)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# NAME_CONST()
create table t1 (a virtual varchar(32) as (name_const('test',1)));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# RELEASE_LOCK()
create table t1 (a varchar(32), b virtual int as (release_lock(a)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# ROW_COUNT()
create table t1 (a virtual int as (row_count()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# SCHEMA()
create table t1 (a virtual varchar(32) as (schema()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# SESSION_USER()
create table t1 (a virtual varchar(32) as (session_user()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# SLEEP()
create table t1 (a int, b virtual int as (sleep(a)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# SYSTEM_USER()
create table t1 (a virtual varchar(32) as (system_user()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# USER()
create table t1 (a varchar(1024), b virtual varchar(1024) as (user()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# UUID_SHORT()
create table t1 (a virtual varchar(1024) as (uuid_short()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# UUID()
create table t1 (a virtual varchar(1024) as (uuid()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
# VALUES()
create table t1 (a varchar(1024), b virtual varchar(1024) as (values(a)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# VERSION()
create table t1 (a varchar(1024), b virtual varchar(1024) as (version()));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# ENCRYPT()
create table t1 (a varchar(1024), b virtual varchar(1024) as (encrypt(a)));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# Stored procedures
create procedure p1()
begin
select current_user();
end //
create function f1()
returns int
begin
return 1;
end //
create table t1 (a virtual int as (p1()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
create table t1 (a virtual int as (f1()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
drop procedure p1;
drop function f1;
# Unknown functions
create table t1 (a virtual int as (f1()));
ERROR HY000: Non-deterministic expression for virtual column 'a'.
#
# GROUP BY FUNCTIONS
#
# AVG()
create table t1 (a int, b virtual int as (avg(a)));
ERROR HY000: Invalid use of group function
# BIT_AND()
create table t1 (a int, b virtual int as (bit_and(a)));
ERROR HY000: Invalid use of group function
# BIT_OR()
create table t1 (a int, b virtual int as (bit_or(a)));
ERROR HY000: Invalid use of group function
# BIT_XOR()
create table t1 (a int, b virtual int as (bit_xor(a)));
ERROR HY000: Invalid use of group function
# COUNT(DISTINCT)
create table t1 (a int, b virtual int as (count(distinct a)));
ERROR HY000: Invalid use of group function
# COUNT()
create table t1 (a int, b virtual int as (count(a)));
ERROR HY000: Invalid use of group function
# GROUP_CONCAT()
create table t1 (a varchar(32), b virtual int as (group_concat(a,'')));
ERROR HY000: Invalid use of group function
# MAX()
create table t1 (a int, b virtual int as (max(a)));
ERROR HY000: Invalid use of group function
# MIN()
create table t1 (a int, b virtual int as (min(a)));
ERROR HY000: Invalid use of group function
# STD()
create table t1 (a int, b virtual int as (std(a)));
ERROR HY000: Invalid use of group function
# STDDEV_POP()
create table t1 (a int, b virtual int as (stddev_pop(a)));
ERROR HY000: Invalid use of group function
# STDDEV_SAMP()
create table t1 (a int, b virtual int as (stddev_samp(a)));
ERROR HY000: Invalid use of group function
# STDDEV()
create table t1 (a int, b virtual int as (stddev(a)));
ERROR HY000: Invalid use of group function
# SUM()
create table t1 (a int, b virtual int as (sum(a)));
ERROR HY000: Invalid use of group function
# VAR_POP()
create table t1 (a int, b virtual int as (var_pop(a)));
ERROR HY000: Invalid use of group function
# VAR_SAMP()
create table t1 (a int, b virtual int as (var_samp(a)));
ERROR HY000: Invalid use of group function
# VARIANCE()
create table t1 (a int, b virtual int as (variance(a)));
ERROR HY000: Invalid use of group function
#
# XML FUNCTIONS
#
# ExtractValue()
create table t1 (a varchar(1024), b virtual varchar(1024) as (ExtractValue(a,'//b[$@j]')));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
# UpdateXML()
create table t1 (a varchar(1024), b virtual varchar(1024) as (UpdateXML(a,'/a','<e>fff</e>')));
ERROR HY000: Non-deterministic expression for virtual column 'b'.
#
# Sub-selects
#
create table t1 (a int);
create table t2 (a int, b virtual int as (select count(*) from t1));
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'select count(*) from t1))' at line 1
drop table t1;
#
# Long expression
create table t1 (a int, b virtual varchar(300) as (concat(a,'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa')));
drop table t1;
create table t1 (a int, b virtual varchar(300) as (concat(a,'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa')));
drop table t1;
#
# Constant expression
create table t1 (a virtual int as (PI()));
ERROR HY000: Constant expression in virtual column function is not allowed.
DROP VIEW  IF EXISTS v1,v2;
DROP TABLE IF EXISTS t1,t2,t3;
DROP PROCEDURE IF EXISTS p1;
DROP FUNCTION IF EXISTS f1;
DROP TRIGGER IF EXISTS trg1;
DROP TRIGGER IF EXISTS trg2;
set sql_warnings = 0;
