
# WL#6301: Change default value for the 'bind-address' option
#
# 3. Check that if the server is bound to the IPv4-mapped IPv6-address,
# the server accepts client connections from both IPv4 and IPv6 worlds.
#
# Options: --skip-name-resolve, --bind-address=::ffff:127.0.0.1
# (see corresponding opt file).
#

# Can't be tested with embedded server
--source include/not_embedded.inc

# Within the WL#7158 records for the users root@127.0.0.1 and root@::1
# have been deleted from the script mysql-test/include/mtr_system_tables_data.sql
# that used to fill in system tables. Since this test relies on the presence of this
# records in the table mysql.user we add the users root@127.0.0.1 and root@::1
# into mysql.user explicitly.

# Backup mysql.user before add a record for root@127.0.0.1 and root@::1
--disable_warnings
DROP TABLE IF EXISTS mysql.user_bak;
CREATE TABLE mysql.user_bak AS SELECT * FROM mysql.user;

INSERT IGNORE INTO mysql.user VALUES ('127.0.0.1','root','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y' ,'Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,@@default_authentication_plugin,'','N', CURRENT_TIMESTAMP,NULL,'N');
INSERT IGNORE INTO mysql.user VALUES ('::1','root','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y' ,'Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,@@default_authentication_plugin,'','N', CURRENT_TIMESTAMP,NULL,'N');
--enable_warnings
COMMIT;
FLUSH PRIVILEGES;

# The box should support IPv4-mapped addresses
--source include/have_ipv4_mapped.inc

--echo # Checking ::ffff:127.0.0.1 ...
--exec $MYSQLADMIN --no-defaults --default-character-set=latin1 -h ::ffff:127.0.0.1 -P $MASTER_MYPORT -u root ping

--echo # Checking 127.0.0.1 ...
--exec $MYSQLADMIN --no-defaults --default-character-set=latin1 -h 127.0.0.1 -P $MASTER_MYPORT -u root ping

# Restore original content of mysql.user
TRUNCATE TABLE mysql.user;
INSERT INTO mysql.user SELECT * FROM mysql.user_bak;
COMMIT;
FLUSH PRIVILEGES;

DROP TABLE mysql.user_bak;

# NOTE: ::1 has nothing to do with ::ffff:127.0.0.1, so the server bound to
# ::ffff:127.0.0.1 will not accept connections from to ::1.
