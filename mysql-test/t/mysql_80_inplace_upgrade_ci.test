--source include/have_case_insensitive_file_system.inc

--let ZIP_FILE= $MYSQLTEST_VARDIR/std_data/upgrade/data_80011_ci_win.zip
if (`SELECT CONVERT(@@version_compile_os USING LATIN1) RLIKE '^(osx|macos)'`)
{
  --let ZIP_FILE= $MYSQLTEST_VARDIR/std_data/upgrade/data_80011_ci_mac.zip
}

--source include/no_valgrind_without_big.inc
--source include/have_debug.inc
--source include/have_innodb_16k.inc

--let $MYSQLD_DATADIR= `select @@datadir`

--echo ###########################################################################
--echo # Stop the default mtr server
--echo ###########################################################################

--echo # Stop DB server which was created by MTR default
--let $shutdown_server_timeout = 300
--source include/shutdown_mysqld.inc

--echo ###########################################################################
--echo # Setup the 8.0.11 data directory
--echo ###########################################################################

--echo # Set different paths for --datadir
let $MYSQLD_DATADIR1 = $MYSQL_TMP_DIR/data_80011_ci;

--echo # Copy the remote tablespace & DB zip files from suite location to working location.
--copy_file $ZIP_FILE $MYSQL_TMP_DIR/data_80011_ci.zip

--echo # Check that the file exists in the working folder.
--file_exists $MYSQL_TMP_DIR/data_80011_ci.zip

--echo # Unzip the zip file.
--exec unzip -qo $MYSQL_TMP_DIR/data_80011_ci.zip -d $MYSQL_TMP_DIR

--echo ###########################################################################
--echo # Test the --no-upgrade option with a 8.0.11 data directory
--echo ###########################################################################

--let $MYSQLD_LOG= $MYSQLTEST_VARDIR/log/mysql80011_no_upgrade.log
--replace_result $MYSQLD MYSQLD $MYSQLD_DATADIR1 MYSQLD_DATADIR1 $MYSQLD_LOG MYSQLD_LOG
--error 1
--exec $MYSQLD --no-defaults --secure-file-priv="" --datadir=$MYSQLD_DATADIR1 --no-upgrade --log-error=$MYSQLD_LOG

--let SEARCH_FILE= $MYSQLD_LOG
--echo # Search for the error message in the server error log.
--let SEARCH_PATTERN= Server shutting down because upgrade is required, yet prohibited by the command line option \'--no-upgrade\'\.
--source include/search_pattern.inc

--echo ###########################################################################
--echo # Test the --minimal-upgrade option with a 8.0.11 data directory
--echo ###########################################################################

--let $MYSQLD_LOG= $MYSQLTEST_VARDIR/log/mysql80011_skip_upgrade.log
--replace_result $MYSQLD MYSQLD $MYSQLD_DATADIR1 MYSQLD_DATADIR1 $MYSQLD_LOG MYSQLD_LOG
--exec echo "restart: --datadir=$MYSQLD_DATADIR1 --minimal-upgrade  --log-error=$MYSQLD_LOG" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--let $wait_counter= 10000
--enable_reconnect
--source include/wait_until_connected_again.inc

--let $shutdown_server_timeout = 300
--source include/shutdown_mysqld.inc

--let SEARCH_FILE= $MYSQLD_LOG
--echo # Search for the error message in the server error log.
--let SEARCH_PATTERN= Column count of mysql\.user is wrong. Expected 51, found 49\. Created with MySQL 80011, now running 80015\.
--source include/search_pattern.inc

--let SEARCH_PATTERN= Server upgrade is required, but skipped by command line option \'--minimal-upgrade\'\.
--source include/search_pattern.inc

--echo ###########################################################################
--echo # Test the --no-upgrade option with a 8.0.11 data directory with upgraded
--echo # data dictionary but skipped server upgrade
--echo ###########################################################################

--let $MYSQLD_LOG= $MYSQLTEST_VARDIR/log/mysql80011_no_upgrade_after_skip.log
--replace_result $MYSQLD MYSQLD $MYSQLD_DATADIR1 MYSQLD_DATADIR1 $MYSQLD_LOG MYSQLD_LOG
--error 1
--exec $MYSQLD --no-defaults --secure-file-priv="" --datadir=$MYSQLD_DATADIR1 --no-upgrade --log-error=$MYSQLD_LOG

--let SEARCH_FILE= $MYSQLD_LOG
--echo # Search for the error message in the server error log.
--let SEARCH_PATTERN= Server shutting down because upgrade is required, yet prohibited by the command line option \'--no-upgrade\'\.
--source include/search_pattern.inc

--echo ###########################################################################
--echo # Complete the upgrade on a data directory that has an upgraded data
--echo # dictionary but skipped server upgrade
--echo ###########################################################################

--let $MYSQLD_LOG= $MYSQLTEST_VARDIR/log/mysql80011_upgrade_after_skip.log
--replace_result $MYSQLD MYSQLD $MYSQLD_DATADIR1 MYSQLD_DATADIR1 $MYSQLD_LOG MYSQLD_LOG
--exec echo "restart: --datadir=$MYSQLD_DATADIR1 --log-error=$MYSQLD_LOG" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--let $wait_counter= 10000
--enable_reconnect
--source include/wait_until_connected_again.inc

--echo # There should be no errors
--let SEARCH_FILE= $MYSQLD_LOG
--let SEARCH_PATTERN= \[ERROR\]
--source include/search_pattern.inc

# It should have created a file in the MySQL Servers datadir
--let $MYSQLD_DATADIR= `select @@datadir`
--file_exists $MYSQLD_DATADIR/mysql_upgrade_info

--echo ###########################################################################
--echo # Cleanup
--echo ###########################################################################

--let $shutdown_server_timeout = 300
--source include/shutdown_mysqld.inc

--force-rmdir $MYSQLD_DATADIR1
--remove_file $MYSQL_TMP_DIR/data_80011_ci.zip

--echo ###########################################################################
--echo # Setup 8.0.11 data directory
--echo ###########################################################################

--echo # Copy the remote tablespace & DB zip files from suite location to working location.
--copy_file $ZIP_FILE $MYSQL_TMP_DIR/data_80011_ci.zip

--echo # Check that the file exists in the working folder.
--file_exists $MYSQL_TMP_DIR/data_80011_ci.zip

--echo # Unzip the zip file.
--exec unzip -qo $MYSQL_TMP_DIR/data_80011_ci.zip -d $MYSQL_TMP_DIR

--echo ###########################################################################
--echo # Test complete upgrade on 8.0.11 data directory
--echo ###########################################################################

--let $MYSQLD_LOG= $MYSQLTEST_VARDIR/log/mysql80011_upgrade_complete.log
--replace_result $MYSQLD MYSQLD $MYSQLD_DATADIR1 MYSQLD_DATADIR1 $MYSQLD_LOG MYSQLD_LOG
--exec echo "restart: --datadir=$MYSQLD_DATADIR1 --log-error=$MYSQLD_LOG" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--let $wait_counter= 10000
--enable_reconnect
--source include/wait_until_connected_again.inc

--echo # There should be no errors
--let SEARCH_FILE= $MYSQLD_LOG
--let SEARCH_PATTERN= \[ERROR\]
--source include/search_pattern.inc

# It should have created a file in the MySQL Servers datadir
--let $MYSQLD_DATADIR= `select @@datadir`
--file_exists $MYSQLD_DATADIR/mysql_upgrade_info

--echo # Stop DB server
--let $shutdown_server_timeout = 300
--source include/shutdown_mysqld.inc

--echo ###########################################################################
--echo # Cleanup
--echo ###########################################################################

--force-rmdir $MYSQLD_DATADIR1
--remove_file $MYSQL_TMP_DIR/data_80011_ci.zip

--let $restart_parameters = restart:
--source include/start_mysqld.inc
