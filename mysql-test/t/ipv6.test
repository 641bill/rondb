
# Test of ipv6 format
# Options: --skip-name-resolve (see corresponding opt file).
#
# Within the WL#7158 records for the users root@127.0.0.1 and root@::1
# have been deleted from the script mysql-test/include/mtr_system_tables_data.sql
# that used to fill in system tables. Since this test relies on the presence of this
# records in the table mysql.user we add the users root@127.0.0.1 and root@::1
# into mysql.user explicitly.

# Backup mysql.user before adding records for root@127.0.0.1, root@::1
--disable_warnings
DROP TABLE IF EXISTS mysql.user_bak;
CREATE TABLE mysql.user_bak AS SELECT * FROM mysql.user;

INSERT IGNORE INTO mysql.user VALUES ('127.0.0.1','root','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y' ,'Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,@@default_authentication_plugin,'','N', CURRENT_TIMESTAMP,NULL,'N');
INSERT IGNORE INTO mysql.user VALUES ('::1','root','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y' ,'Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,@@default_authentication_plugin,'','N', CURRENT_TIMESTAMP,NULL,'N');
--enable_warnings
COMMIT;
FLUSH PRIVILEGES;

--source include/check_ipv6.inc
# Can't be tested with embedded server
--source include/not_embedded.inc

# Save the initial number of concurrent sessions
--source include/count_sessions.inc

echo =============Test of '::1' ========================================;
let $IPv6= ::1;
--source include/ipv6_clients.inc
--source include/ipv6.inc
--source include/ipv6_func.inc

echo =============Test of '127.0.0.1' (IPv4) ===========================;
let $IPv6= 127.0.0.1;
--source include/ipv6_clients.inc
--source include/ipv6.inc
--source include/ipv6_func.inc

echo =============Test of '::1/128' ====================================;
let $IPv6= ::1/128;
#--source include/ipv6_clients.inc
#--source include/ipv6.inc

echo =============Test of '0000:0000:0000:0000:0000:0000:0000:0001' ====;
let $IPv6= 0000:0000:0000:0000:0000:0000:0000:0001;
--source include/ipv6_clients.inc
--source include/ipv6.inc
--source include/ipv6_func.inc

echo =============Test of '0:0:0:0:0:0:0:1' ============================;
let $IPv6= 0:0:0:0:0:0:0:1;
--source include/ipv6_clients.inc
--source include/ipv6.inc
--source include/ipv6_func.inc

# Restore original content of mysql.user
TRUNCATE TABLE mysql.user;
INSERT INTO mysql.user SELECT * FROM mysql.user_bak;
COMMIT;
FLUSH PRIVILEGES;

DROP TABLE mysql.user_bak;

# Wait till all disconnects are completed
--source include/wait_until_count_sessions.inc
