# The include statement below is a temp one for tests that are yet to
#be ported to run with InnoDB,
#but needs to be kept for tests that would need MyISAM in future.
--source include/force_myisam_default.inc

--source include/not_embedded.inc
--source include/have_partition.inc

--echo # Setup
CREATE TABLE t (
    firstname VARCHAR(25) NOT NULL,
    lastname VARCHAR(25) NOT NULL,
    username VARCHAR(16) NOT NULL,
    email VARCHAR(35),
    joined DATE NOT NULL
)
PARTITION BY KEY(joined)
PARTITIONS 6;

--echo # Restart the server without partition engine.
let $restart_parameters = restart: --skip-partition;
--source include/restart_mysqld.inc

--disable_abort_on_error
#
# Bug#39893: Crash if select on a partitioned table,
#            when partitioning is disabled
SELECT * FROM t;
TRUNCATE TABLE t;
ANALYZE TABLE t;
CHECK TABLE t;
OPTIMIZE TABLE t;
REPAIR TABLE t;
ALTER TABLE t REPAIR PARTITION ALL;
ALTER TABLE t CHECK PARTITION ALL;
ALTER TABLE t OPTIMIZE PARTITION ALL;
ALTER TABLE t ANALYZE PARTITION ALL;
ALTER TABLE t REBUILD PARTITION ALL;
ALTER TABLE t TRUNCATE PARTITION ALL;
ALTER TABLE t ENGINE Memory;
ALTER TABLE t ADD (new INT);
DROP TABLE t;

CREATE TABLE t1 (
    firstname VARCHAR(25) NOT NULL,
    lastname VARCHAR(25) NOT NULL,
    username VARCHAR(16) NOT NULL,
    email VARCHAR(35),
    joined DATE NOT NULL
)
PARTITION BY KEY(joined)
PARTITIONS 6;

CREATE TABLE t1 (
    firstname VARCHAR(25) NOT NULL,
    lastname VARCHAR(25) NOT NULL,
    username VARCHAR(16) NOT NULL,
    email VARCHAR(35),
    joined DATE NOT NULL
);
ALTER TABLE t1 PARTITION BY KEY(joined) PARTITIONS 2;

drop table t1;

CREATE TABLE t1 (
    firstname VARCHAR(25) NOT NULL,
    lastname VARCHAR(25) NOT NULL,
    username VARCHAR(16) NOT NULL,
    email VARCHAR(35),
    joined DATE NOT NULL
)
PARTITION BY RANGE( YEAR(joined) ) (
    PARTITION p0 VALUES LESS THAN (1960),
    PARTITION p1 VALUES LESS THAN (1970),
    PARTITION p2 VALUES LESS THAN (1980),
    PARTITION p3 VALUES LESS THAN (1990),
    PARTITION p4 VALUES LESS THAN MAXVALUE
);

CREATE TABLE t1 (id INT, purchased DATE)
    PARTITION BY RANGE( YEAR(purchased) )
    SUBPARTITION BY HASH( TO_DAYS(purchased) )
    SUBPARTITIONS 2 (
        PARTITION p0 VALUES LESS THAN (1990),
        PARTITION p1 VALUES LESS THAN (2000),
        PARTITION p2 VALUES LESS THAN MAXVALUE
    );

# Create a table without partitions to test "EXPLAIN PARTITIONS"
create table t1 (a varchar(10) charset latin1 collate latin1_bin);
insert into t1 values (''),(' '),('a'),('a '),('a  ');
--replace_column 11 #
explain partitions select * from t1 where a='a ' OR a='a';
drop table t1;
--echo #
--echo # bug#11760213-52599: ALTER TABLE REMOVE PARTITIONING ON NON-PARTITIONED
--echo #                                 TABLE CORRUPTS MYISAM
CREATE TABLE `t1` (`a` INT) ENGINE=myisam;
ALTER TABLE `t1` ADD COLUMN `b` INT;
CREATE UNIQUE INDEX `i1` ON `t1`(`b`);
CREATE UNIQUE INDEX `i2` ON `t1`(`a`);
ALTER TABLE `t1` ADD PRIMARY KEY  (`a`);
ALTER TABLE `t1` REMOVE PARTITIONING;
CHECK TABLE `t1` EXTENDED;
DROP TABLE t1;
--enable_abort_on_error

--echo # Restart the server.
let $restart_parameters = restart;
--source include/restart_mysqld.inc

# Cleanup
DROP TABLE t;
