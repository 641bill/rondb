# 
# DROP-related tests which execution requires debug server.
#
--source include/have_debug.inc

--echo #
--echo # Bug#21625393 : Assert condition (e->usage() == 1) failure in
--echo #                dd::cache::Shared_multi_map<T>::remove()
--echo #

--enable_connect_log

--echo #
--echo # Create MyISAM table, and drop it, but make drop fail
--echo # before the object is deleted from the dd tables. Now,
--echo # the object exists in the global data dictionary, but
--echo # not in the SE.

CREATE TABLE t1 (i INT) ENGINE=MyISAM;

--connect (con1, localhost, root)
SET SESSION DEBUG='+d,fail_while_dropping_dd_object';
--error ER_LOCK_WAIT_TIMEOUT
DROP TABLE t1;
SET SESSION DEBUG='-d,fail_while_dropping_dd_object';

--connection default
--echo # Drop the table for real. Use IF EXISTS clause to ignore
--echo # the fact that table does not exist in SE.
--echo # Without the fix this statement will fail with assert.
DROP TABLE IF EXISTS t1;

--connection con1
--disconnect con1
--source include/wait_until_disconnected.inc
--connection default

--disable_connect_log
